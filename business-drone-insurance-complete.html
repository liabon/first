<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²¬ì ì„œ í™•ì¸ - KBì†í•´ë³´í—˜ ì—…ë¬´ìš© ë“œë¡ ë³´í—˜</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --kb-yellow: #FFCD00; --kb-gold: #FFB800; --kb-dark: #1a1a1a; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            color: var(--kb-dark);
            line-height: 1.6;
            background: linear-gradient(135deg, #1a3a6b 0%, #2d5fa8 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo-section { display: flex; align-items: center; gap: 1.5rem; }
        .kb-logo { height: 50px; }
        .divider { height: 40px; width: 1px; background: #ddd; }
        .agency-name { font-size: 1.5rem; font-weight: 700; color: var(--kb-dark); }
        .home-btn { padding: 0.7rem 1.3rem; background: var(--kb-gold); color: var(--kb-dark); border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-block; font-size: 0.95rem; }
        .home-btn:hover { background: var(--kb-yellow); transform: translateY(-2px); }
        .main-content { flex: 1; display: flex; align-items: flex-start; justify-content: center; padding: 3rem 2rem; }
        .complete-card { background: #fff; border-radius: 30px; padding: 4rem 3rem; max-width: 820px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .title-section { text-align: center; margin-bottom: 3rem; }
        .success-icon { width: 80px; height: 80px; background: var(--kb-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem; }
        .complete-title { font-size: 2rem; font-weight: 900; margin-bottom: 0.5rem; }
        .complete-subtitle { font-size: 1rem; color: #666; }
        .quote-box { background: #f8f9fa; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; }
        .quote-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--kb-gold); border-bottom: 2px solid var(--kb-gold); padding-bottom: 0.5rem; }
        .info-row { display: flex; justify-content: space-between; align-items: flex-start; padding: 0.75rem 0; border-bottom: 1px solid #e8e8e8; gap: 1rem; }
        .info-row:last-child { border-bottom: none; }
        .info-label { font-weight: 600; color: #666; white-space: nowrap; font-size: 0.95rem; }
        .info-value { font-weight: 700; color: var(--kb-dark); text-align: right; font-size: 0.95rem; }
        .drone-card { margin: 1.2rem 0; padding: 1.4rem; background: #fff; border-radius: 12px; border: 2px solid #e8e8e8; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .drone-card-header { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1rem; padding-bottom: 0.7rem; border-bottom: 2px solid var(--kb-gold); }
        .drone-card-title { font-weight: 800; color: var(--kb-gold); font-size: 1.05rem; }
        .plan-badge { display: inline-block; background: var(--kb-gold); color: var(--kb-dark); font-size: 0.8rem; font-weight: 700; padding: 0.2rem 0.7rem; border-radius: 20px; margin-left: auto; }
        .total-price-box { background: var(--kb-gold); padding: 1.5rem; border-radius: 12px; text-align: center; margin: 2rem 0; }
        .total-price-label { font-size: 1rem; margin-bottom: 0.4rem; font-weight: 600; }
        .total-price-value { font-size: 2.5rem; font-weight: 900; color: var(--kb-dark); }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .nav-buttons { display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; }
        .btn { padding: 1.1rem; border: none; border-radius: 12px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.3s; font-family: 'Noto Sans KR', sans-serif; display: flex; align-items: center; justify-content: center; gap: 0.4rem; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .btn-pdf { background: #e74c3c; color: #fff; }
        .btn-pdf:hover:not(:disabled) { background: #c0392b; transform: translateY(-2px); }
        .btn-email { background: var(--kb-gold); color: var(--kb-dark); }
        .btn-email:hover:not(:disabled) { background: var(--kb-yellow); transform: translateY(-2px); }
        .btn-back { background: #e0e0e0; color: var(--kb-dark); }
        .btn-back:hover { background: #d0d0d0; }
        .btn-payment { background: var(--kb-dark); color: #fff; }
        .btn-payment:hover { background: #000; transform: translateY(-2px); }
        .notice { background: #fff9e6; padding: 1.4rem; border-radius: 12px; margin-top: 1.5rem; font-size: 0.92rem; color: #666; line-height: 1.9; }
        .notice strong { color: var(--kb-dark); display: block; margin-bottom: 0.5rem; font-size: 1rem; }
        footer { background: var(--kb-dark); color: #fff; padding: 2rem; }
        .footer-content { max-width: 1200px; margin: 0 auto; text-align: center; font-size: 0.9rem; opacity: 0.8; }
        @media (max-width: 768px) {
            .complete-card { padding: 2.5rem 1.5rem; border-radius: 20px; }
            .action-buttons, .nav-buttons { grid-template-columns: 1fr; }
            .total-price-value { font-size: 2rem; }
        }
        @media (max-width: 480px) {
            .main-content { padding: 1.5rem 0.75rem; }
            .complete-card { padding: 2rem 1rem; border-radius: 16px; }
            .info-row { flex-direction: column; gap: 0.1rem; }
            .info-value { text-align: left; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="logo-section">
            <img src="kb-logo.png" alt="KBì†í•´ë³´í—˜" class="kb-logo">
            <div class="divider"></div>
            <div class="agency-name">ë°°ìƒì˜¨ ëŒ€ë¦¬ì </div>
        </div>
        <a href="/business-drone-insurance" class="home-btn">ğŸ  í™ˆìœ¼ë¡œ</a>
    </div>
</header>

<div class="main-content">
    <div class="complete-card">
        <div class="title-section">
            <div class="success-icon">ğŸ“‹</div>
            <h1 class="complete-title">ì—…ë¬´ìš© ë“œë¡ ë³´í—˜ ê²¬ì ì„œ</h1>
            <p class="complete-subtitle">ì…ë ¥í•˜ì‹  ì •ë³´ë¥¼ í™•ì¸í•˜ì‹œê³  ê²¬ì ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ì´ë©”ì¼ë¡œ ë°›ì•„ë³´ì„¸ìš”</p>
        </div>

        <div class="quote-box">
            <h2 class="quote-title">ë³´í—˜ ì •ë³´</h2>
            <div id="basicInfo"><p style="color:#999;text-align:center;padding:1rem;">ë¡œë”© ì¤‘...</p></div>
        </div>

        <div id="dronesSection"></div>

        <div class="total-price-box">
            <div class="total-price-label">ì—°ê°„ ì´ ë³´í—˜ë£Œ</div>
            <div class="total-price-value" id="totalPrice">0ì›</div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-pdf"   id="pdfBtn"   onclick="downloadPDF()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-email" id="emailBtn" onclick="sendEmail()">ğŸ“§ ì´ë©”ì¼ ì „ì†¡</button>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-back"    onclick="history.back()">ì´ì „</button>
            <button class="btn btn-payment" onclick="alert('ê²°ì œ ì—°ë™ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\nì´ë©”ì¼ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.')">ğŸ’³ ê²°ì œí•˜ê¸°</button>
        </div>

        <div class="notice">
            <strong>ì•ˆë‚´ì‚¬í•­</strong>
            â€¢ ê²¬ì ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ì´ë©”ì¼ë¡œ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
            â€¢ ê°€ì…ì„ ì›í•˜ì‹œë©´ ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br>
            â€¢ ê²¬ì ì„œëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ë³´í—˜ë£ŒëŠ” ì‹¬ì‚¬ í›„ í™•ì •ë©ë‹ˆë‹¤.<br>
            â€¢ ë¬¸ì˜ì‚¬í•­: <span id="noticeEmail"></span>
        </div>
    </div>
</div>

<footer>
    <div class="footer-content">
        <p>Â© 2026 ë°°ìƒì˜¨ ëŒ€ë¦¬ì . All rights reserved. | KBì†í•´ë³´í—˜ ê³µì‹ ëŒ€ë¦¬ì </p>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
'use strict';

var EMAIL = 'liab.on.ins' + '@' + 'gmail.com';

// ê°€ì…ë¬¼ê±´(ì¤‘ëŸ‰) ë¼ë²¨ â€” "ìì²´ì¤‘ëŸ‰ êµ¬ë¶„" ëŒ€ì‹  "ê°€ì…ë¬¼ê±´"ìœ¼ë¡œ í‘œì‹œ
var WEIGHT_LABELS = {
    'under_25kg': '25kg ë¯¸ë§Œ (ì˜ë¬´/ì—…ë¬´/ì˜ë¦¬)',
    '25_100kg':   '25kg ì´ìƒ 100kg ë¯¸ë§Œ (ì˜ë¬´/ì—…ë¬´/ì˜ë¦¬)',
    'over_100kg': '100kg ì´ìƒ'
};

var insuranceData = null;

/* â”€â”€ ì´ˆê¸°í™” â”€â”€ */
window.addEventListener('DOMContentLoaded', function() {
    var el = document.getElementById('noticeEmail');
    if (el) {
        var a = document.createElement('a');
        a.href = 'mailto:' + EMAIL;
        a.textContent = EMAIL;
        a.style.color = '#888';
        el.appendChild(a);
    }

    var raw = '';
    try { raw = sessionStorage.getItem('businessDroneData') || ''; } catch(e) {}

    if (!raw) {
        document.getElementById('basicInfo').innerHTML =
            '<p style="color:#e74c3c;text-align:center;padding:2rem;line-height:2.5;">' +
            'ì €ì¥ëœ ë³´í—˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.<br>' +
            '<a href="/business-drone-insurance" style="color:#FFB800;font-weight:700;">ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</a></p>';
        return;
    }

    try {
        insuranceData = JSON.parse(raw);
    } catch(e) {
        document.getElementById('basicInfo').innerHTML =
            '<p style="color:#e74c3c;text-align:center;">ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        return;
    }

    displayInfo();
});

/* â”€â”€ í™”ë©´ í‘œì‹œ
   â€» "ìì²´ì¤‘ëŸ‰ êµ¬ë¶„" â†’ "ê°€ì…ë¬¼ê±´" ìœ¼ë¡œ í‘œì‹œ
   â€» "ë“œë¡  ìœ í˜•" ì œê±°
â”€â”€ */
function displayInfo() {
    var d = insuranceData;
    if (!d) return;

    function fmtDT(s) { return (s || '').replace('T', ' '); }
    function row(label, val) {
        if (!val && val !== 0) return '';
        return '<div class="info-row">' +
               '<span class="info-label">' + label + '</span>' +
               '<span class="info-value">' + val + '</span>' +
               '</div>';
    }

    // ê¸°ë³¸ ì •ë³´ (ìì²´ì¤‘ëŸ‰ êµ¬ë¶„Â·ë“œë¡  ìœ í˜• ì œê±°, ê°€ì…ë¬¼ê±´ ì¶”ê°€)
    var basic = '';
    if (d.corp_name) {
        basic += row('ë²•ì¸ëª…',         d.corp_name);
        if (d.corp_number) basic += row('ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸', d.corp_number);
    } else {
        basic += row('ê°€ì…ìëª…', d.name);
    }
    basic += row('ì—°ë½ì²˜',   d.phone);
    basic += row('ì´ë©”ì¼',   d.email);
    basic += row('ë³´í—˜ê¸°ê°„', fmtDT(d.insurance_start) + ' ~ ' + fmtDT(d.insurance_end));
    basic += row('ë“œë¡  ëŒ€ìˆ˜', (d.drone_count || 1) + 'ëŒ€');
    // ê°€ì…ë¬¼ê±´ (ìì²´ì¤‘ëŸ‰ êµ¬ë¶„ ë¼ë²¨ì„ "ê°€ì…ë¬¼ê±´"ìœ¼ë¡œ)
    if (d.drone_weight) {
        basic += row('ê°€ì…ë¬¼ê±´', WEIGHT_LABELS[d.drone_weight] || d.drone_weight);
    }
    basic += row('ìê¸°ë¶€ë‹´ê¸ˆ', (d.selected_deductible || '10') + 'ë§Œì›');

    document.getElementById('basicInfo').innerHTML = basic;

    // ë“œë¡ ë³„ ìƒì„¸ ì¹´ë“œ
    var count  = parseInt(d.drone_count) || 1;
    var drones = d.drones      || [];
    var plans  = d.drone_plans || [];
    var html   = '';

    for (var i = 0; i < count; i++) {
        var dr = drones[i] || {};
        var pl = plans[i]  || {};
        html += '<div class="drone-card">';
        html += '<div class="drone-card-header">';
        html += '<span style="font-size:1.2rem;">ğŸš</span>';
        html += '<span class="drone-card-title">ë“œë¡  ' + (i + 1) + '</span>';
        if (pl.plan_name) html += '<span class="plan-badge">' + pl.plan_name + '</span>';
        html += '</div>';
        if (dr.model)      html += row('ëª¨ë¸ëª…',     dr.model);
        if (dr.serial)     html += row('ì‹œë¦¬ì–¼ë²ˆí˜¸', dr.serial);
        if (dr.reg)        html += row('ì‹ ê³ ë²ˆí˜¸',   dr.reg);
        if (dr.weight)     html += row('ìì²´ì¤‘ëŸ‰',   dr.weight + 'kg');
        if (dr.max_weight) html += row('ìµœëŒ€ì´ë¥™ì¤‘ëŸ‰', dr.max_weight + 'kg');
        if (pl.plan_name)  html += row('ì„ íƒ í”Œëœ',  pl.plan_name);
        if (pl.coverage_personal) html += row('ëŒ€ì¸ë°°ìƒ', pl.coverage_personal);
        if (pl.coverage_property) html += row('ëŒ€ë¬¼ë°°ìƒ', pl.coverage_property);
        html += '<div class="info-row">' +
                '<span class="info-label">ë³´í—˜ë£Œ</span>' +
                '<span class="info-value" style="color:#FFB800;">' +
                parseInt(pl.price || 0).toLocaleString() + 'ì›/ë…„</span></div>';
        html += '</div>';
    }

    document.getElementById('dronesSection').innerHTML = html;
    document.getElementById('totalPrice').textContent =
        parseInt(d.plan_total_price || 0).toLocaleString() + 'ì›';
}

/* â”€â”€ PDF ë‹¤ìš´ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â˜… ë¹ˆ í˜ì´ì§€ í•´ê²°: position:absolute;left:-99999px (off-screen)
     opacity:0 / z-index ìŒìˆ˜ëŠ” html2canvas ìº¡ì²˜ ë¶ˆê°€ â†’ ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
   â˜… ë ˆì´ì•„ì›ƒ (ëª¨ë‘ table, gradient/grid/flex ì—†ìŒ)
     â‘ í—¤ë”           : â‰¤2cm, ê¸€ì”¨ 11px
     â‘¡ê²¬ì ì •ë³´|ê³ ê°ì •ë³´ : 2ì»¬ëŸ¼
     â‘¢ë³´í—˜ì¡°ê±´|ë“œë¡ ì •ë³´ : 2ì»¬ëŸ¼, ë“œë¡  ì—¬ëŸ¬ëŒ€ ìš°ì¸¡ì— ìŒ“ì„
     â‘£ì—°ê°„ì´ë³´í—˜ë£Œ    : â‰¤2cm, ê¸€ì”¨ 16px
     â‘¤ìœ ì˜ì‚¬í•­ â‘¥í‘¸í„°
   â˜… ì˜ë¦¼ ë°©ì§€: page-break-inside:avoid + avoid-all
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function downloadPDF() {
    if (!insuranceData) { alert('ë³´í—˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

    var pdfBtn = document.getElementById('pdfBtn');
    pdfBtn.disabled = true;
    pdfBtn.textContent = 'ìƒì„± ì¤‘...';

    var wrapper = null;
    try {
        var d        = insuranceData;
        var today    = new Date();
        var dateStr  = today.getFullYear() + 'ë…„ ' + (today.getMonth()+1) + 'ì›” ' + today.getDate() + 'ì¼';
        var count    = parseInt(d.drone_count) || 1;
        var drones   = d.drones      || [];
        var plans    = d.drone_plans || [];
        var total    = parseInt(d.plan_total_price || 0);
        var custName = d.corp_name || d.name || '';

        var W = 760; // px â€” A4 190mm @ 96dpi ê·¼ì‚¬

        function fmtDT(s) { return (s||'').replace('T',' '); }
        function safe(v)  { return (v != null && v !== '') ? String(v) : 'ë¯¸ì…ë ¥'; }

        // ì„¹ì…˜ í—¤ë” í–‰ (colspan=2)
        function secHead(label, gold) {
            var bg = gold ? '#FFB800' : '#1a1a1a';
            var fg = gold ? '#1a1a1a' : '#FFB800';
            return '<tr><td colspan="2" style="background:' + bg + ';padding:5px 8px;' +
                   'font-size:8px;font-weight:700;color:' + fg + ';letter-spacing:0.3px;">' +
                   label + '</td></tr>';
        }

        // ë°ì´í„° í–‰ (label / value, ì¤„ë¬´ëŠ¬)
        function irow(label, val, alt) {
            var bg = alt ? 'background:#f6f6f6;' : '';
            return '<tr style="' + bg + '">' +
                   '<td style="padding:3.5px 8px;font-size:8px;color:#555;width:38%;' +
                   'border-bottom:1px solid #ebebeb;">' + label + '</td>' +
                   '<td style="padding:3.5px 8px;font-size:8px;font-weight:600;' +
                   'border-bottom:1px solid #ebebeb;">' + safe(val) + '</td></tr>';
        }
        function irow_price(val) {
            return '<tr><td style="padding:3.5px 8px;font-size:8px;color:#555;width:38%;' +
                   'border-bottom:1px solid #ebebeb;">ë³´í—˜ë£Œ</td>' +
                   '<td style="padding:3.5px 8px;font-size:8px;font-weight:700;' +
                   'color:#b87000;border-bottom:1px solid #ebebeb;">' + val + '</td></tr>';
        }

        // ì¸ë¼ì¸ í…Œì´ë¸” ë˜í¼ (full-width, border-collapse)
        function tbl(inner) {
            return '<table width="100%" cellpadding="0" cellspacing="0" ' +
                   'style="border-collapse:collapse;">' + inner + '</table>';
        }

        // ê°€ì…ë¬¼ê±´ ë¼ë²¨
        var weightLabel = d.drone_weight ? (WEIGHT_LABELS[d.drone_weight] || d.drone_weight) : 'ë¯¸ì…ë ¥';

        /* â”€ ë“œë¡  ì¹´ë“œë“¤ â”€ */
        var droneCards = '';
        for (var i = 0; i < count; i++) {
            var dr = drones[i] || {};
            var pl = plans[i]  || {};
            var planTxt = pl.plan_name ? ' [' + safe(pl.plan_name) + ']' : '';
            var inner =
                secHead('ë“œë¡  ' + (i+1) + planTxt, true) +
                irow('ëª¨ë¸ëª…',    safe(dr.model),    false) +
                irow('ì‹œë¦¬ì–¼ë²ˆí˜¸', safe(dr.serial),   true) +
                (dr.weight     ? irow('ìì²´ì¤‘ëŸ‰',    dr.weight + 'kg',    false) : '') +
                (dr.max_weight ? irow('ìµœëŒ€ì´ë¥™ì¤‘ëŸ‰', dr.max_weight + 'kg', true)  : '') +
                (pl.coverage_personal ? irow('ëŒ€ì¸ë°°ìƒ', safe(pl.coverage_personal), false) : '') +
                (pl.coverage_property ? irow('ëŒ€ë¬¼ë°°ìƒ', safe(pl.coverage_property), true)  : '') +
                irow_price(parseInt(pl.price||0).toLocaleString() + 'ì›/ë…„');

            droneCards +=
                '<div style="page-break-inside:avoid;margin-bottom:4px;">' +
                tbl(inner) + '</div>';
        }

        /* â”€ ì „ì²´ PDF HTML â”€ */
        var html =
        /* ì»¨í…Œì´ë„ˆ */
        '<div style="width:' + W + 'px;font-family:Arial,Helvetica,sans-serif;' +
        'color:#1a1a1a;background:#ffffff;">' +

        /* â‘  í—¤ë” (â‰¤2cm) */
        '<table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:5px;">' +
        '<tr><td style="background:#FFB800;padding:6px 0;text-align:center;">' +
        '<div style="font-size:11px;font-weight:900;color:#1a1a1a;line-height:1.2;">' +
        'ë°°ìƒì˜¨ ì—…ë¬´ìš©ë“œë¡ ë³´í—˜ ê²¬ì ì„œ</div>' +
        '</td></tr></table>' +

        /* â‘¡ ê²¬ì ì •ë³´ | ê³ ê°ì •ë³´ (2ì»¬ëŸ¼) */
        '<table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:5px;">' +
        '<tr>' +

        /* ê²¬ì ì •ë³´ */
        '<td width="49%" valign="top" style="padding-right:3px;">' +
        tbl(
            secHead('ê²¬ì  ì •ë³´', false) +
            irow('ê²¬ì ì¼ì', dateStr,                    false) +
            irow('ë³´í—˜ì‹œì‘', fmtDT(d.insurance_start),   true) +
            irow('ë³´í—˜ì¢…ë£Œ', fmtDT(d.insurance_end),     false) +
            irow('ìƒí’ˆëª…',   'KBì†í•´ë³´í—˜ ì—…ë¬´ìš©ë“œë¡ ë³´í—˜', true)
        ) +
        '</td>' +

        '<td width="2%" style="min-width:4px;"></td>' +

        /* ê³ ê°ì •ë³´ */
        '<td width="49%" valign="top" style="padding-left:3px;">' +
        tbl(
            secHead('ê³ ê° ì •ë³´', false) +
            (d.corp_name
                ? irow('ë²•ì¸ëª…', safe(d.corp_name), false) +
                  (d.corp_number ? irow('ì‚¬ì—…ìë²ˆí˜¸', safe(d.corp_number), true) : '')
                : irow('ì´ë¦„', safe(d.name), false)) +
            irow('ì—°ë½ì²˜', safe(d.phone), true) +
            irow('ì´ë©”ì¼', safe(d.email), false)
        ) +
        '</td>' +
        '</tr></table>' +

        /* â‘¢ ë³´í—˜ì¡°ê±´ | ë“œë¡ ì •ë³´ (2ì»¬ëŸ¼, 38:62) */
        '<table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:5px;">' +
        '<tr>' +

        /* ë³´í—˜ì¡°ê±´ */
        '<td width="37%" valign="top" style="padding-right:3px;">' +
        tbl(
            secHead('ë³´í—˜ ì¡°ê±´', false) +
            irow('ê°€ì…ë¬¼ê±´',   weightLabel,                          false) +
            irow('ë“œë¡  ëŒ€ìˆ˜',  count + 'ëŒ€',                         true)  +
            irow('ìê¸°ë¶€ë‹´ê¸ˆ', (d.selected_deductible||'10') + 'ë§Œì›', false)
        ) +
        '</td>' +

        '<td width="2%" style="min-width:4px;"></td>' +

        /* ë“œë¡ ì •ë³´ */
        '<td width="61%" valign="top" style="padding-left:3px;">' +
        '<table width="100%" cellpadding="0" cellspacing="0" style="border-collapse:collapse;margin-bottom:3px;">' +
        '<tr><td style="background:#1a1a1a;padding:5px 8px;font-size:8px;' +
        'font-weight:700;color:#FFB800;">ë“œë¡  ì •ë³´ (' + count + 'ëŒ€)</td></tr>' +
        '</table>' +
        droneCards +
        '</td>' +
        '</tr></table>' +

        /* â‘£ ì—°ê°„ ì´ ë³´í—˜ë£Œ (â‰¤2cm) */
        '<div style="page-break-inside:avoid;">' +
        '<table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:5px;">' +
        '<tr><td style="background:#FFB800;padding:6px 0;text-align:center;">' +
        '<div style="font-size:8px;color:#1a1a1a;font-weight:600;margin-bottom:2px;">ì—°ê°„ ì´ ë³´í—˜ë£Œ</div>' +
        '<div style="font-size:16px;font-weight:900;color:#1a1a1a;line-height:1.15;">' +
        total.toLocaleString() + 'ì›</div>' +
        '</td></tr></table>' +

        /* â‘¤ ìœ ì˜ì‚¬í•­ */
        '<table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:5px;">' +
        '<tr><td style="background:#fffbea;padding:6px 10px;font-size:7px;' +
        'color:#555;line-height:1.7;">' +
        '<strong style="color:#1a1a1a;font-size:7.5px;display:block;margin-bottom:2px;">ìœ ì˜ì‚¬í•­</strong>' +
        'â€» êµ¬ì²´ì ì¸ ë³´ì¥/ë©´ì±… ë° ë³´í—˜ê¸ˆ ì§€ê¸‰ì€ ì•½ê´€ì— ë”°ë¦…ë‹ˆë‹¤.<br>' +
        'â€» ë³¸ ê²¬ì ì„œëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ë³´í—˜ë£ŒëŠ” ì‹¬ì‚¬ í›„ í™•ì •ë©ë‹ˆë‹¤.' +
        '</td></tr></table>' +
        '</div>' +

        /* â‘¥ í‘¸í„° */
        '<table width="100%" cellpadding="0" cellspacing="0">' +
        '<tr><td style="background:#1a1a1a;padding:7px;text-align:center;">' +
        '<div style="font-size:8px;font-weight:700;color:#ffffff;margin-bottom:2px;">ë°°ìƒì˜¨ ëŒ€ë¦¬ì </div>' +
        '<div style="font-size:7px;color:#aaaaaa;">' +
        'liab.on.ins@gmail.com  |  www.liab.co.kr  |  KBì†í•´ë³´í—˜ ê³µì‹ ëŒ€ë¦¬ì </div>' +
        '</td></tr></table>' +

        '</div>'; /* ì»¨í…Œì´ë„ˆ ë */

        /* â”€â”€ DOM ì‚½ì… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           â˜… position:absolute;left:-99999px â€” off-screen, ë ˆì´ì•„ì›ƒ í”Œë¡œìš° ìœ ì§€
           â˜… opacity:0 / z-index ìŒìˆ˜ ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€ (html2canvas ìº¡ì²˜ ì‹¤íŒ¨)
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        wrapper = document.createElement('div');
        wrapper.setAttribute('aria-hidden', 'true');
        wrapper.style.cssText =
            'position:absolute;left:-99999px;top:0;' +
            'width:' + W + 'px;overflow:visible;background:#fff;';
        wrapper.innerHTML = html;
        document.body.appendChild(wrapper);

        // ë Œë”ë§ ë°˜ì˜ì„ ìœ„í•œ ìµœì†Œ ëŒ€ê¸° (1í”„ë ˆì„)
        await new Promise(function(res){ setTimeout(res, 150); });

        var filename = 'KB_ì—…ë¬´ìš©ë“œë¡ ë³´í—˜_ê²¬ì ì„œ_' + custName + '_' +
            today.getFullYear() +
            String(today.getMonth()+1).padStart(2,'0') +
            String(today.getDate()).padStart(2,'0') + '.pdf';

        await html2pdf().set({
            margin:      [8, 8, 8, 8],
            filename:    filename,
            image:       { type: 'jpeg', quality: 0.97 },
            html2canvas: {
                scale:           2,
                useCORS:         true,
                letterRendering: true,
                logging:         false,
                scrollY:         0,
                scrollX:         0,
                windowWidth:     W
            },
            jsPDF:     { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css'] }
        }).from(wrapper).save();

    } catch(err) {
        console.error('PDF ì˜¤ë¥˜:', err);
        alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + err.message);
    } finally {
        if (wrapper && wrapper.parentNode) {
            wrapper.parentNode.removeChild(wrapper);
        }
        pdfBtn.disabled = false;
        pdfBtn.textContent = 'ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ';
    }
}

/* â”€â”€ ì´ë©”ì¼ ì „ì†¡ â”€â”€ */
async function sendEmail() {
    if (!insuranceData) { alert('ë³´í—˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    var emailAddr = insuranceData.email || '';
    if (!emailAddr) { alert('ì´ë©”ì¼ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

    var emailBtn = document.getElementById('emailBtn');
    emailBtn.disabled = true;
    emailBtn.textContent = 'ì „ì†¡ ì¤‘...';

    try {
        var res = await fetch('/api/contact', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(Object.assign({}, insuranceData, {
                insurance_type:   'ì—…ë¬´ìš© ë“œë¡ ë³´í—˜',
                request_type:     'quote_email'
            }))
        });
        if (res.ok) {
            alert('ê²¬ì ì„œê°€ ' + emailAddr + ' ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert('ì´ë©”ì¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    } catch(e) {
        console.error('ì´ë©”ì¼ ì˜¤ë¥˜:', e);
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
        emailBtn.disabled = false;
        emailBtn.textContent = 'ğŸ“§ ì´ë©”ì¼ ì „ì†¡';
    }
}
</script>
</body>
</html>
