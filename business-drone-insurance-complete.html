<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²¬ì ì„œ í™•ì¸ - KBì†í•´ë³´í—˜ ì—…ë¬´ìš© ë“œë¡ ë³´í—˜</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --kb-yellow: #FFCD00; --kb-gold: #FFB800; --kb-dark: #1a1a1a; }

        /* â•â•â• í™”ë©´ ìŠ¤íƒ€ì¼ â•â•â• */
        body {
            font-family: 'Noto Sans KR', sans-serif; color: var(--kb-dark); line-height: 1.6;
            background: linear-gradient(135deg, #1a3a6b 0%, #2d5fa8 100%);
            min-height: 100vh; display: flex; flex-direction: column;
        }
        header { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo-section { display: flex; align-items: center; gap: 1.5rem; }
        .kb-logo { height: 50px; }
        .divider { height: 40px; width: 1px; background: #ddd; }
        .agency-name { font-size: 1.5rem; font-weight: 700; }
        .home-btn { padding: 0.7rem 1.3rem; background: var(--kb-gold); color: var(--kb-dark); border: none; border-radius: 8px; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-block; }
        .main-content { flex: 1; display: flex; align-items: flex-start; justify-content: center; padding: 3rem 2rem; }
        .complete-card { background: #fff; border-radius: 30px; padding: 4rem 3rem; max-width: 820px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .title-section { text-align: center; margin-bottom: 3rem; }
        .success-icon { width: 80px; height: 80px; background: var(--kb-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem; }
        .complete-title { font-size: 2rem; font-weight: 900; margin-bottom: 0.5rem; }
        .complete-subtitle { font-size: 1rem; color: #666; }
        .quote-box { background: #f8f9fa; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; }
        .quote-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--kb-gold); border-bottom: 2px solid var(--kb-gold); padding-bottom: 0.5rem; }
        .info-row { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e8e8e8; gap: 1rem; }
        .info-row:last-child { border-bottom: none; }
        .info-label { font-weight: 600; color: #666; white-space: nowrap; }
        .info-value { font-weight: 700; text-align: right; }
        .drone-card { margin: 1.2rem 0; padding: 1.4rem; background: #fff; border-radius: 12px; border: 2px solid #e8e8e8; }
        .drone-card-header { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1rem; padding-bottom: 0.7rem; border-bottom: 2px solid var(--kb-gold); }
        .drone-card-title { font-weight: 800; color: var(--kb-gold); }
        .plan-badge { background: var(--kb-gold); color: var(--kb-dark); font-size: 0.8rem; font-weight: 700; padding: 0.2rem 0.7rem; border-radius: 20px; margin-left: auto; }
        .total-price-box { background: var(--kb-gold); padding: 1.5rem; border-radius: 12px; text-align: center; margin: 2rem 0; }
        .total-price-label { font-size: 1rem; margin-bottom: 0.4rem; font-weight: 600; }
        .total-price-value { font-size: 2.5rem; font-weight: 900; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .nav-buttons { display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; }
        .btn { padding: 1.1rem; border: none; border-radius: 12px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.3s; font-family: 'Noto Sans KR', sans-serif; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-pdf { background: #e74c3c; color: #fff; }
        .btn-pdf:hover:not(:disabled) { background: #c0392b; }
        .btn-email { background: var(--kb-gold); color: var(--kb-dark); }
        .btn-back { background: #e0e0e0; }
        .btn-payment { background: var(--kb-dark); color: #fff; }
        .notice { background: #fff9e6; padding: 1.4rem; border-radius: 12px; margin-top: 1.5rem; font-size: 0.92rem; color: #666; line-height: 2; }
        .notice strong { color: var(--kb-dark); display: block; margin-bottom: 0.5rem; }
        footer { background: var(--kb-dark); color: #fff; padding: 2rem; }
        .footer-content { max-width: 1200px; margin: 0 auto; text-align: center; font-size: 0.9rem; opacity: 0.8; }

        /* ë””ë²„ê·¸ ë°•ìŠ¤ */
        #debugBox { background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:1rem;margin-bottom:1rem;font-size:0.85rem;display:none; }

        @media (max-width: 768px) {
            .complete-card { padding: 2rem 1rem; }
            .action-buttons, .nav-buttons { grid-template-columns: 1fr; }
        }

        /* â•â•â• ì¸ì‡„ ì „ìš© â•â•â• */
        /* í™”ë©´ì—ì„œëŠ” #printArea ìˆ¨ê¹€ */
        #printArea { display: none; }

        @media print {
            /* í™”ë©´ ìš”ì†Œ ì „ë¶€ ìˆ¨ê¹€ */
            body > * { display: none !important; }
            /* #printAreaë§Œ í‘œì‹œ â€” body ì§ì ‘ ìì‹ì´ë¯€ë¡œ ìˆ¨ê¹€ ì•ˆ ë¨ */
            #printArea { display: block !important; }

            @page { margin: 12mm; size: A4 portrait; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

            #printArea { font-family: 'Noto Sans KR', Arial, sans-serif; color: #1a1a1a; font-size: 10px; }
            .pa-header { background: #FFB800 !important; padding: 10px 20px; text-align: center; margin-bottom: 10px; }
            .pa-header h1 { font-size: 17px; font-weight: 900; color: #1a1a1a; margin: 0; }
            .pa-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
            .pa-box { background: #f5f5f5 !important; padding: 9px 11px; border-radius: 5px; page-break-inside: avoid; }
            .pa-box h3 { font-size: 10px; font-weight: 700; color: #b87000; margin: 0 0 5px 0; }
            .pa-box p { font-size: 9.5px; margin: 2px 0; line-height: 1.4; }
            .pa-cond { background: #f5f5f5 !important; padding: 9px 11px; border-radius: 5px; margin-bottom: 8px; page-break-inside: avoid; }
            .pa-cond h3 { font-size: 10px; font-weight: 700; color: #b87000; margin: 0 0 5px 0; }
            .pa-cond p { font-size: 9.5px; margin: 2px 0; }
            .pa-drones-title { font-size: 10px; font-weight: 700; color: #b87000; margin: 8px 0 4px 0; }
            .pa-drone { background: #f5f5f5 !important; padding: 9px 11px; border-radius: 5px; margin-bottom: 6px; page-break-inside: avoid; }
            .pa-drone h4 { font-size: 10px; font-weight: 700; color: #b87000; margin: 0 0 4px 0; }
            .pa-drone p { font-size: 9px; margin: 2px 0; line-height: 1.4; }
            .pa-drone hr { border: none; border-top: 1px solid #ddd; margin: 5px 0; }
            .pa-price-gold { color: #b87000; font-weight: 700; }
            .pa-total { background: #FFB800 !important; padding: 10px 20px; border-radius: 6px; text-align: center; margin: 10px 0; page-break-inside: avoid; }
            .pa-total p { font-size: 9.5px; font-weight: 600; color: #1a1a1a; margin: 0 0 3px 0; }
            .pa-total .pa-total-price { font-size: 22px; font-weight: 900; color: #1a1a1a; }
            .pa-notice { background: #fffbea !important; padding: 7px 10px; border-radius: 5px; font-size: 8.5px; color: #555; line-height: 1.7; margin: 8px 0; page-break-inside: avoid; }
            .pa-notice strong { color: #1a1a1a; display: block; margin-bottom: 2px; font-size: 9px; }
            .pa-footer { background: #1a1a1a !important; color: #fff; padding: 8px 15px; text-align: center; border-radius: 5px; }
            .pa-footer p { font-size: 8.5px; margin: 2px 0; line-height: 1.4; }
            .pa-footer .pa-fname { font-size: 11px; font-weight: 700; }
        }
    </style>
</head>
<body>

<!-- â•â•â• ì¸ì‡„ ì „ìš© ì˜ì—­ (body ì§ì ‘ ìì‹ â€” í™”ë©´ ìˆ¨ê¹€, ì¸ì‡„ ì‹œ ë‹¨ë… í‘œì‹œ) â•â•â• -->
<div id="printArea"></div>

<!-- â•â•â• í™”ë©´ UI â•â•â• -->
<header>
    <div class="header-content">
        <div class="logo-section">
            <img src="kb-logo.png" alt="KBì†í•´ë³´í—˜" class="kb-logo">
            <div class="divider"></div>
            <div class="agency-name">ë°°ìƒì˜¨ ëŒ€ë¦¬ì </div>
        </div>
        <a href="/business-drone-insurance" class="home-btn">ğŸ  í™ˆìœ¼ë¡œ</a>
    </div>
</header>

<div class="main-content">
    <div class="complete-card">

        <div class="title-section">
            <div class="success-icon">ğŸ“‹</div>
            <h1 class="complete-title">ì—…ë¬´ìš© ë“œë¡ ë³´í—˜ ê²¬ì ì„œ</h1>
            <p class="complete-subtitle">ì…ë ¥í•˜ì‹  ì •ë³´ë¥¼ í™•ì¸í•˜ê³  PDFë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ì´ë©”ì¼ë¡œ ë°›ìœ¼ì„¸ìš”</p>
        </div>

        <div id="debugBox"></div>

        <div class="quote-box">
            <h2 class="quote-title">ë³´í—˜ ì •ë³´</h2>
            <div id="basicInfo"><p style="color:#999;padding:1rem;text-align:center;">ë¡œë”© ì¤‘...</p></div>
        </div>

        <div id="dronesSection"></div>

        <div class="total-price-box">
            <div class="total-price-label">ì—°ê°„ ì´ ë³´í—˜ë£Œ</div>
            <div class="total-price-value" id="totalPrice">0ì›</div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-pdf"   onclick="downloadPDF()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-email" id="emailBtn" onclick="sendEmail()">ğŸ“§ ì´ë©”ì¼ ì „ì†¡</button>
        </div>
        <div class="nav-buttons" style="margin-top:1rem;">
            <button class="btn btn-back"    onclick="history.back()">ì´ì „</button>
            <button class="btn btn-payment" onclick="alert('ê²°ì œ ì—°ë™ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')">ğŸ’³ ê²°ì œí•˜ê¸°</button>
        </div>

        <div class="notice">
            <strong>ì•ˆë‚´ì‚¬í•­</strong>
            â€¢ ê²¬ì ì„œë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ì´ë©”ì¼ë¡œ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
            â€¢ ê°€ì…ì„ ì›í•˜ì‹œë©´ ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br>
            â€¢ ê²¬ì ì„œëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ë³´í—˜ë£ŒëŠ” ì‹¬ì‚¬ í›„ í™•ì •ë©ë‹ˆë‹¤.<br>
            â€¢ ë¬¸ì˜: <span id="contactEmail"></span>
        </div>

    </div>
</div>

<footer>
    <div class="footer-content">
        <p>Â© 2026 ë°°ìƒì˜¨ ëŒ€ë¦¬ì . All rights reserved. | KBì†í•´ë³´í—˜ ê³µì‹ ëŒ€ë¦¬ì </p>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
'use strict';

var EMAIL = 'liab.on.ins' + '@' + 'gmail.com';
var WEIGHT_LABELS = {
    'under_25kg': '25kg ë¯¸ë§Œ (ì˜ë¬´/ì—…ë¬´/ì˜ë¦¬)',
    '25_100kg'  : '25kg ì´ìƒ 100kg ë¯¸ë§Œ (ì˜ë¬´/ì—…ë¬´/ì˜ë¦¬)',
    'over_100kg': '100kg ì´ìƒ'
};
var insuranceData = null;

/* â”€â”€â”€ ì´ˆê¸°í™” â”€â”€â”€ */
window.addEventListener('DOMContentLoaded', function() {
    // ì´ë©”ì¼
    var el = document.getElementById('contactEmail');
    if (el) el.innerHTML = '<a href="mailto:' + EMAIL + '" style="color:#888;">' + EMAIL + '</a>';

    // â‘  businessDroneData ì‹œë„
    var raw = '';
    var usedKey = '';
    try { raw = sessionStorage.getItem('businessDroneData') || ''; usedKey = 'businessDroneData'; } catch(e) {}

    // â‘¡ ì—†ìœ¼ë©´ droneFormData ì‹œë„ (URLSearchParams í˜•íƒœ)
    if (!raw) {
        try {
            var raw2 = sessionStorage.getItem('droneFormData') || '';
            if (raw2) {
                raw = convertFormDataToJSON(raw2);
                usedKey = 'droneFormData(ë³€í™˜)';
            }
        } catch(e) {}
    }

    // â‘¢ ë””ë²„ê·¸: ëª¨ë“  sessionStorage í‚¤ ì¶œë ¥
    var allKeys = [];
    try {
        for (var k = 0; k < sessionStorage.length; k++) allKeys.push(sessionStorage.key(k));
    } catch(e) {}

    if (!raw) {
        var dbg = document.getElementById('debugBox');
        dbg.style.display = 'block';
        dbg.innerHTML = '<strong>âš  sessionStorageì— ë³´í—˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</strong><br>' +
            'í˜„ì¬ ì €ì¥ëœ í‚¤: <code>' + (allKeys.length ? allKeys.join(', ') : 'ì—†ìŒ') + '</code><br>' +
            '<small>terms í˜ì´ì§€ì—ì„œ ë‹¤ìŒìœ¼ë¡œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë°ì´í„°ê°€ ì €ì¥ë©ë‹ˆë‹¤.</small>';
        document.getElementById('basicInfo').innerHTML =
            '<p style="color:#e74c3c;padding:1rem;">ë°ì´í„° ì—†ìŒ â€” <a href="/business-drone-insurance" style="color:#FFB800;font-weight:700;">ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘</a></p>';
        return;
    }

    try {
        insuranceData = JSON.parse(raw);
    } catch(e) {
        document.getElementById('basicInfo').innerHTML = '<p style="color:#e74c3c;">ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ' + e.message + '</p>';
        return;
    }

    displayInfo();
    buildPrintArea();
});

/* droneFormData(URLSearchParams) â†’ JSON ë¬¸ìì—´ ë³€í™˜ */
function convertFormDataToJSON(raw) {
    try {
        var p = new URLSearchParams(raw);
        var droneCount = parseInt(p.get('drone_count') || '1');
        var drones = [], plans = [];
        for (var i = 0; i < droneCount; i++) {
            drones.push({ model: p.get('drone_model_' + i) || '', serial: p.get('drone_serial_' + i) || '', weight: p.get('drone_weight_' + i) || '', max_weight: p.get('drone_mtow_' + i) || '' });
            plans.push({ plan_name: p.get('plan_name_' + i) || '', price: p.get('plan_price_' + i) || '0', coverage_personal: p.get('plan_coverage_personal_' + i) || '', coverage_property: p.get('plan_coverage_property_' + i) || '' });
        }
        var obj = {
            name: p.get('name') || p.get('corp_name') || '',
            corp_name: p.get('corp_name') || '',
            corp_number: p.get('corp_number') || '',
            phone: p.get('phone') || p.get('corp_phone') || '',
            email: p.get('email') || p.get('corp_email') || '',
            insurance_start: p.get('insurance_start') || '',
            insurance_end: p.get('insurance_end') || '',
            drone_count: droneCount,
            drone_weight: p.get('drone_weight') || '',
            selected_deductible: p.get('selected_deductible') || '10',
            plan_total_price: p.get('plan_total_price') || '0',
            drones: drones,
            drone_plans: plans
        };
        return JSON.stringify(obj);
    } catch(e) { return ''; }
}

/* â”€â”€â”€ í™”ë©´ í‘œì‹œ â”€â”€â”€ */
function displayInfo() {
    var d = insuranceData;
    function fmtDT(s) { return (s || '').replace('T', ' '); }
    function row(lbl, val) {
        if (val == null || val === '') return '';
        return '<div class="info-row"><span class="info-label">' + lbl + '</span><span class="info-value">' + val + '</span></div>';
    }
    var basic = '';
    if (d.corp_name) {
        basic += row('ë²•ì¸ëª…', d.corp_name);
        if (d.corp_number) basic += row('ì‚¬ì—…ìë²ˆí˜¸', d.corp_number);
    } else { basic += row('ì´ë¦„', d.name); }
    basic += row('ì—°ë½ì²˜', d.phone);
    basic += row('ì´ë©”ì¼', d.email);
    basic += row('ë³´í—˜ê¸°ê°„', fmtDT(d.insurance_start) + ' ~ ' + fmtDT(d.insurance_end));
    basic += row('ë“œë¡  ëŒ€ìˆ˜', (d.drone_count || 1) + 'ëŒ€');
    if (d.drone_weight) basic += row('ê°€ì…ë¬¼ê±´', WEIGHT_LABELS[d.drone_weight] || d.drone_weight);
    basic += row('ìê¸°ë¶€ë‹´ê¸ˆ', (d.selected_deductible || '10') + 'ë§Œì›');
    document.getElementById('basicInfo').innerHTML = basic || '<p style="color:#999;">í‘œì‹œí•  ë°ì´í„° ì—†ìŒ</p>';

    var count = parseInt(d.drone_count) || 1;
    var drones = d.drones || [], plans = d.drone_plans || [];
    var html = '';
    for (var i = 0; i < count; i++) {
        var dr = drones[i] || {}, pl = plans[i] || {};
        html += '<div class="drone-card"><div class="drone-card-header">' +
            '<span style="font-size:1.2rem;">ğŸš</span>' +
            '<span class="drone-card-title">ë“œë¡  ' + (i+1) + '</span>' +
            (pl.plan_name ? '<span class="plan-badge">' + pl.plan_name + '</span>' : '') +
            '</div>';
        if (dr.model)             html += row('ëª¨ë¸ëª…',       dr.model);
        if (dr.serial)            html += row('ì‹œë¦¬ì–¼ë²ˆí˜¸',   dr.serial);
        if (dr.weight)            html += row('ìì²´ì¤‘ëŸ‰',     dr.weight + 'kg');
        if (dr.max_weight)        html += row('ìµœëŒ€ì´ë¥™ì¤‘ëŸ‰', dr.max_weight + 'kg');
        if (pl.plan_name)         html += row('ì„ íƒ í”Œëœ',    pl.plan_name);
        if (pl.coverage_personal) html += row('ëŒ€ì¸ë°°ìƒ',     pl.coverage_personal);
        if (pl.coverage_property) html += row('ëŒ€ë¬¼ë°°ìƒ',     pl.coverage_property);
        html += '<div class="info-row"><span class="info-label">ë³´í—˜ë£Œ</span>' +
            '<span class="info-value" style="color:#FFB800;">' + parseInt(pl.price || 0).toLocaleString() + 'ì›/ë…„</span></div>' +
            '</div>';
    }
    document.getElementById('dronesSection').innerHTML = html;
    document.getElementById('totalPrice').textContent = parseInt(d.plan_total_price || 0).toLocaleString() + 'ì›';
}

/* â”€â”€â”€ ì¸ì‡„ ì˜ì—­ ìƒì„± â”€â”€â”€ */
function buildPrintArea() {
    var d = insuranceData;
    if (!d) return;
    function fmtDT(s) { return (s || '').replace('T', ' '); }
    function safe(v) { return (v != null && v !== '') ? String(v) : 'ë¯¸ì…ë ¥'; }

    var today = new Date();
    var dateStr = today.getFullYear() + '. ' + (today.getMonth()+1) + '. ' + today.getDate() + '.';
    var count = parseInt(d.drone_count) || 1;
    var drones = d.drones || [], plans = d.drone_plans || [];
    var total = parseInt(d.plan_total_price || 0);
    var weightLabel = d.drone_weight ? (WEIGHT_LABELS[d.drone_weight] || d.drone_weight) : 'ë¯¸ì…ë ¥';

    var droneCards = '';
    for (var i = 0; i < count; i++) {
        var dr = drones[i] || {}, pl = plans[i] || {};
        droneCards +=
            '<div class="pa-drone">' +
            '<h4>ğŸš ë“œë¡  ' + (i+1) + (pl.plan_name ? ' â€” ' + safe(pl.plan_name) : '') + '</h4>' +
            '<p><strong>ëª¨ë¸ëª…:</strong> ' + safe(dr.model) + '</p>' +
            '<p><strong>ì‹œë¦¬ì–¼ë²ˆí˜¸:</strong> ' + safe(dr.serial) + '</p>' +
            (dr.weight     ? '<p><strong>ìì²´ì¤‘ëŸ‰:</strong> '     + dr.weight     + 'kg</p>' : '') +
            (dr.max_weight ? '<p><strong>ìµœëŒ€ì´ë¥™ì¤‘ëŸ‰:</strong> ' + dr.max_weight + 'kg</p>' : '') +
            '<hr>' +
            (pl.coverage_personal ? '<p>ëŒ€ì¸ë°°ìƒ: ' + safe(pl.coverage_personal) + '</p>' : '') +
            (pl.coverage_property ? '<p>ëŒ€ë¬¼ë°°ìƒ: ' + safe(pl.coverage_property) + '</p>' : '') +
            '<p class="pa-price-gold"><strong>ë³´í—˜ë£Œ: ' + parseInt(pl.price || 0).toLocaleString() + 'ì›/ë…„</strong></p>' +
            '</div>';
    }

    var custInfo = d.corp_name
        ? '<p><strong>ë²•ì¸ëª…:</strong> ' + safe(d.corp_name) + '</p>' +
          (d.corp_number ? '<p><strong>ì‚¬ì—…ìë²ˆí˜¸:</strong> ' + safe(d.corp_number) + '</p>' : '')
        : '<p><strong>ì´ë¦„:</strong> ' + safe(d.name) + '</p>';

    document.getElementById('printArea').innerHTML =
        '<div class="pa-header"><h1>ë°°ìƒì˜¨ ì—…ë¬´ìš©ë“œë¡ ë³´í—˜ ê²¬ì ì„œ</h1></div>' +

        '<div class="pa-grid">' +
        '<div class="pa-box"><h3>ğŸ“‹ ê²¬ì  ì •ë³´</h3>' +
        '<p><strong>ê²¬ì ì¼ì:</strong> ' + dateStr + '</p>' +
        '<p><strong>ë³´í—˜ê¸°ê°„:</strong> ' + fmtDT(d.insurance_start) + ' ~ ' + fmtDT(d.insurance_end) + '</p>' +
        '<p><strong>ìƒí’ˆëª…:</strong> KBì†í•´ë³´í—˜ ì—…ë¬´ìš©ë“œë¡ ë³´í—˜</p>' +
        '</div>' +
        '<div class="pa-box"><h3>ğŸ‘¤ ê³ ê° ì •ë³´</h3>' +
        custInfo +
        '<p><strong>ì—°ë½ì²˜:</strong> ' + safe(d.phone) + '</p>' +
        '<p><strong>ì´ë©”ì¼:</strong> ' + safe(d.email) + '</p>' +
        '</div></div>' +

        '<div class="pa-cond"><h3>ğŸ“„ ë³´í—˜ ì¡°ê±´</h3>' +
        '<p><strong>ê°€ì…ë¬¼ê±´:</strong> ' + weightLabel + '</p>' +
        '<p><strong>ë“œë¡  ëŒ€ìˆ˜:</strong> ' + count + 'ëŒ€</p>' +
        '<p><strong>ìê¸°ë¶€ë‹´ê¸ˆ:</strong> ' + safe(d.selected_deductible) + 'ë§Œì›</p>' +
        '</div>' +

        '<p class="pa-drones-title">ğŸš ë“œë¡  ì •ë³´ (' + count + 'ëŒ€)</p>' +
        droneCards +

        '<div class="pa-total"><p>ì—°ê°„ ì´ ë³´í—˜ë£Œ</p><div class="pa-total-price">' + total.toLocaleString() + 'ì›</div></div>' +

        '<div class="pa-notice"><strong>ìœ ì˜ì‚¬í•­</strong>' +
        'â€» êµ¬ì²´ì ì¸ ë³´ì¥/ë©´ì±… ë° ë³´í—˜ê¸ˆ ì§€ê¸‰ì€ ì•½ê´€ì— ë”°ë¦…ë‹ˆë‹¤.<br>' +
        'â€» ë³¸ ê²¬ì ì„œëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ë³´í—˜ë£ŒëŠ” ì‹¬ì‚¬ í›„ í™•ì •ë©ë‹ˆë‹¤.' +
        '</div>' +

        '<div class="pa-footer">' +
        '<p class="pa-fname">ë°°ìƒì˜¨ ëŒ€ë¦¬ì </p>' +
        '<p>liab.on.ins@gmail.com | www.liab.co.kr</p>' +
        '<p style="opacity:0.7;">KBì†í•´ë³´í—˜ ê³µì‹ ëŒ€ë¦¬ì </p>' +
        '</div>';
}

/* â”€â”€â”€ PDF ë‹¤ìš´ë¡œë“œ (jsPDF ì§ì ‘ ë“œë¡œì‰ â€” html2canvas ë¯¸ì‚¬ìš©) â”€â”€â”€ */
function downloadPDF() {
    if (!insuranceData) { alert('ë³´í—˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

    var d        = insuranceData;
    var count    = parseInt(d.drone_count) || 1;
    var drones   = d.drones      || [];
    var plans    = d.drone_plans || [];
    var total    = parseInt(d.plan_total_price || 0);
    var custName = d.corp_name || d.name || '';
    var weightLabel = d.drone_weight ? (WEIGHT_LABELS[d.drone_weight] || d.drone_weight) : '';

    function fmtDT(s) { return (s || '').replace('T', ' '); }
    function safe(v)  { return (v != null && v !== '') ? String(v) : 'ë¯¸ì…ë ¥'; }

    /* jsPDF */
    var doc = new window.jspdf.jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
    var pw  = 210;   // í˜ì´ì§€ ë„ˆë¹„
    var ph  = 297;   // í˜ì´ì§€ ë†’ì´
    var ml  = 14;    // ì¢Œ ì—¬ë°±
    var mr  = 14;    // ìš° ì—¬ë°±
    var cw  = pw - ml - mr;  // ë‚´ìš© ë„ˆë¹„
    var y   = 0;

    /* í—¬í¼: ìƒ‰ ì±„ìš´ ì‚¬ê°í˜• */
    function fillRect(x, ry, w, h, hex) {
        var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
        doc.setFillColor(r, g, b);
        doc.rect(x, ry, w, h, 'F');
    }

    /* í—¬í¼: í…ìŠ¤íŠ¸ */
    function txt(str, x, ty, size, hex, bold) {
        var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
        doc.setTextColor(r, g, b);
        doc.setFontSize(size);
        doc.setFont('helvetica', bold ? 'bold' : 'normal');
        doc.text(String(str), x, ty);
    }

    /* í—¬í¼: ì¤„ í…ìŠ¤íŠ¸ (ë¼ë²¨ + ê°’) */
    function row(label, value, ry, alt) {
        if (alt) fillRect(ml, ry - 4, cw, 6.5, '#f5f5f5');
        txt(label, ml + 2, ry, 9, '#666666', false);
        txt(safe(value), ml + cw * 0.42, ry, 9, '#1a1a1a', true);
        return ry + 7;
    }

    /* í—¬í¼: ì„¹ì…˜ í—¤ë” ë°” */
    function sectionBar(label, ry) {
        fillRect(ml, ry, cw, 7, '#1a1a1a');
        txt(label, ml + 2, ry + 5, 9, '#FFB800', true);
        return ry + 9;
    }

    /* í—¬í¼: í˜ì´ì§€ ë„˜ê¹€ ì²´í¬ */
    function checkY(need) {
        if (y + need > ph - 20) {
            doc.addPage();
            y = 15;
        }
    }

    /* ë‚ ì§œ */
    var today = new Date();
    var dateStr = today.getFullYear() + '. ' + (today.getMonth()+1) + '. ' + today.getDate() + '.';

    /* â‘  í—¤ë” */
    fillRect(0, 0, pw, 18, '#FFB800');
    txt('Baesangon - Business Drone Insurance Quote', pw/2, 8, 11, '#1a1a1a', true);
    doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(60,40,0);
    doc.text('KB Insurance Official Agency', pw/2, 14, { align: 'center' });
    y = 22;

    /* â‘¡ ê²¬ì  ì •ë³´ & ê³ ê° ì •ë³´ â€” 2ì»¬ëŸ¼ */
    var colW = (cw - 4) / 2;
    var col2 = ml + colW + 4;

    /* ì™¼ìª½: ê²¬ì  ì •ë³´ */
    fillRect(ml, y, colW, 7, '#1a1a1a');
    txt('Quote Info', ml + 2, y + 5, 9, '#FFB800', true);
    var yL = y + 9;
    var rows1 = [['Date', dateStr], ['Start', fmtDT(d.insurance_start)], ['End', fmtDT(d.insurance_end)], ['Product', 'KB Business Drone Ins.']];
    rows1.forEach(function(r, i) {
        if (i%2) fillRect(ml, yL-4, colW, 6.5, '#f5f5f5');
        txt(r[0], ml+2, yL, 8.5, '#666', false);
        // ê¸´ í…ìŠ¤íŠ¸ ì¤„ì„
        var val = safe(r[1]); if (val.length > 22) val = val.slice(0,20)+'..';
        txt(val, ml+colW*0.42, yL, 8.5, '#1a1a1a', true);
        yL += 7;
    });

    /* ì˜¤ë¥¸ìª½: ê³ ê° ì •ë³´ */
    fillRect(col2, y, colW, 7, '#1a1a1a');
    txt('Customer Info', col2 + 2, y + 5, 9, '#FFB800', true);
    var yR = y + 9;
    var custRows = [];
    if (d.corp_name) {
        custRows.push(['Corp.', d.corp_name]);
        if (d.corp_number) custRows.push(['Biz No.', d.corp_number]);
    } else { custRows.push(['Name', d.name]); }
    custRows.push(['Phone', d.phone]);
    custRows.push(['Email', d.email]);
    custRows.forEach(function(r, i) {
        if (i%2) fillRect(col2, yR-4, colW, 6.5, '#f5f5f5');
        txt(r[0], col2+2, yR, 8.5, '#666', false);
        var val = safe(r[1]); if (val.length > 22) val = val.slice(0,20)+'..';
        txt(val, col2+colW*0.42, yR, 8.5, '#1a1a1a', true);
        yR += 7;
    });

    y = Math.max(yL, yR) + 4;

    /* â‘¢ ë³´í—˜ ì¡°ê±´ */
    checkY(40);
    y = sectionBar('Insurance Conditions', y);
    var condRows = [
        ['Object', weightLabel || 'N/A'],
        ['Drones',  count + ' unit(s)'],
        ['Deductible', (d.selected_deductible||'10') + ' man-won']
    ];
    condRows.forEach(function(r, i) {
        if (i%2) fillRect(ml, y-4, cw, 6.5, '#f5f5f5');
        txt(r[0], ml+2, y, 9, '#666', false);
        txt(safe(r[1]), ml+cw*0.42, y, 9, '#1a1a1a', true);
        y += 7;
    });
    y += 3;

    /* â‘£ ë“œë¡ ë³„ ì •ë³´ */
    for (var i = 0; i < count; i++) {
        var dr = drones[i] || {};
        var pl = plans[i]  || {};
        var droneHeight = 10 + 7 * 6 + 4;
        checkY(droneHeight);

        /* ë“œë¡  í—¤ë” (ê¸ˆìƒ‰) */
        fillRect(ml, y, cw, 7, '#FFB800');
        txt('Drone ' + (i+1) + (pl.plan_name ? '  [' + pl.plan_name + ']' : ''), ml+2, y+5, 9, '#1a1a1a', true);
        y += 9;

        var drRows = [
            ['Model',  dr.model],
            ['Serial', dr.serial],
            ['Weight', dr.weight ? dr.weight+'kg' : null],
            ['MTOW',   dr.max_weight ? dr.max_weight+'kg' : null],
            ['Liability (Personal)', pl.coverage_personal],
            ['Liability (Property)', pl.coverage_property]
        ].filter(function(r){ return r[1]; });

        drRows.forEach(function(r, ri) {
            if (ri%2) fillRect(ml, y-4, cw, 6.5, '#f5f5f5');
            txt(r[0], ml+2, y, 8.5, '#666', false);
            var val = safe(r[1]); if(val.length>28) val=val.slice(0,26)+'..';
            txt(val, ml+cw*0.42, y, 8.5, '#1a1a1a', true);
            y += 7;
        });

        /* ë³´í—˜ë£Œ (ê¸ˆìƒ‰ í…ìŠ¤íŠ¸) */
        fillRect(ml, y-4, cw, 6.5, '#fffbea');
        txt('Premium', ml+2, y, 8.5, '#666', false);
        txt(parseInt(pl.price||0).toLocaleString() + ' KRW/yr', ml+cw*0.42, y, 8.5, '#b87000', true);
        y += 9;
    }

    /* â‘¤ ì—°ê°„ ì´ ë³´í—˜ë£Œ */
    checkY(18);
    fillRect(ml, y, cw, 16, '#FFB800');
    txt('Annual Total Premium', ml + cw/2, y + 6, 10, '#1a1a1a', false);
    doc.setFontSize(14); doc.setFont('helvetica','bold');
    doc.setTextColor(26,26,26);
    doc.text(total.toLocaleString() + ' KRW / yr', ml + cw/2, y + 13, { align: 'center' });
    y += 20;

    /* â‘¥ ìœ ì˜ì‚¬í•­ */
    checkY(18);
    fillRect(ml, y, cw, 16, '#fffbea');
    txt('Notice', ml+2, y+5, 8, '#1a1a1a', true);
    txt('* Coverage/exclusions and claim payment follow the policy terms.', ml+2, y+10, 7.5, '#666', false);
    txt('* This quote is for reference only. Final premium is subject to underwriting.', ml+2, y+15, 7.5, '#666', false);
    y += 20;

    /* â‘¦ í‘¸í„° */
    checkY(16);
    fillRect(ml, y, cw, 14, '#1a1a1a');
    txt('Baesangon Agency', ml+cw/2, y+5, 9, '#ffffff', true);
    doc.setFontSize(7.5); doc.setFont('helvetica','normal'); doc.setTextColor(180,180,180);
    doc.text('liab.on.ins@gmail.com  |  www.liab.co.kr  |  KB Insurance Official Agency', ml+cw/2, y+10, { align: 'center' });

    /* ì €ì¥ */
    var filename = 'KB_ì—…ë¬´ìš©ë“œë¡ ë³´í—˜_ê²¬ì ì„œ_' + custName + '_' +
        today.getFullYear() +
        String(today.getMonth()+1).padStart(2,'0') +
        String(today.getDate()).padStart(2,'0') + '.pdf';
    doc.save(filename);
}

/* â”€â”€â”€ ì´ë©”ì¼ â”€â”€â”€ */
async function sendEmail() {
    if (!insuranceData) { alert('ë³´í—˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    var emailAddr = insuranceData.email || '';
    if (!emailAddr) { alert('ì´ë©”ì¼ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    var btn = document.getElementById('emailBtn');
    btn.disabled = true; btn.textContent = 'ì „ì†¡ ì¤‘...';
    try {
        var res = await fetch('/api/contact', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(Object.assign({}, insuranceData, { insurance_type: 'ì—…ë¬´ìš© ë“œë¡ ë³´í—˜', request_type: 'quote_email' }))
        });
        alert(res.ok ? ('ê²¬ì ì„œê°€ ' + emailAddr + ' ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.') : 'ì´ë©”ì¼ ì „ì†¡ ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } catch(e) { alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
    finally { btn.disabled = false; btn.textContent = 'ğŸ“§ ì´ë©”ì¼ ì „ì†¡'; }
}
</script>
</body>
</html>
