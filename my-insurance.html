<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>ê³„ì•½ ì¡°íšŒ/ë³€ê²½ - ë°°ìƒì˜¨ ëŒ€ë¦¬ì </title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --gold:  #FFB800;
            --yellow:#FFCD00;
            --dark:  #1a1a1a;
            --gray:  #666;
            --light: #f8f9fa;
            --red:   #e74c3c;
            --green: #27ae60;
            --radius:14px;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, sans-serif;
            color: var(--dark);
            background: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
        }

        /* â”€â”€ HEADER â”€â”€ */
        header {
            background: #fff;
            box-shadow: 0 1px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-section { display: flex; align-items: center; gap: 0.9rem; }
        .kb-logo { height: 38px; }
        .divider { height: 28px; width: 1px; background: #ddd; }
        .agency-name { font-size: 1.1rem; font-weight: 800; }
        .back-home {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.55rem 1.1rem;
            background: var(--gold);
            color: var(--dark);
            border-radius: 20px;
            text-decoration: none;
            font-weight: 700;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        .back-home:hover { background: var(--yellow); }

        /* â”€â”€ MAIN WRAP â”€â”€ */
        .main {
            flex: 1;
            max-width: 640px;
            width: 100%;
            margin: 0 auto;
            padding: 1.5rem 1rem 3rem;
        }

        /* â”€â”€ PAGE HEADER â”€â”€ */
        .page-head {
            text-align: center;
            margin-bottom: 1.8rem;
        }
        .page-head h1 { font-size: 1.6rem; font-weight: 900; margin-bottom: 0.4rem; }
        .page-head p  { color: var(--gray); font-size: 0.9rem; line-height: 1.5; }

        /* â”€â”€ CARD â”€â”€ */
        .card {
            background: #fff;
            border-radius: 18px;
            padding: 1.6rem 1.4rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.07);
            margin-bottom: 1rem;
        }
        .card-title {
            font-size: 1.05rem;
            font-weight: 800;
            margin-bottom: 1.4rem;
            padding-bottom: 0.8rem;
            border-bottom: 2.5px solid var(--gold);
        }

        /* â”€â”€ FORM â”€â”€ */
        .form-group { margin-bottom: 1.1rem; }
        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.18s, box-shadow 0.18s;
            appearance: none;
            -webkit-appearance: none;
            background: #fff;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(255,184,0,0.12);
        }
        .form-group input.err { border-color: var(--red); background: #fff8f8; }
        .hint { font-size: 0.78rem; color: var(--gray); margin-top: 0.35rem; }
        .field-err { font-size: 0.8rem; color: var(--red); font-weight: 600; margin-top: 0.3rem; display: none; }
        .field-err.show { display: block; }

        /* â”€â”€ OTP ROW â”€â”€ */
        .otp-row { display: flex; gap: 0.6rem; }
        .otp-row input { flex: 1; min-width: 0; }
        .otp-btn {
            flex-shrink: 0;
            padding: 0 1.1rem;
            height: 50px;
            background: var(--dark);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
            font-family: inherit;
        }
        .otp-btn:hover { background: #333; }
        .otp-btn:disabled { background: #bbb; cursor: not-allowed; }
        .otp-timer { font-size: 0.8rem; color: var(--red); font-weight: 600; margin-top: 0.3rem; display: none; }

        /* â”€â”€ BUTTONS â”€â”€ */
        .btn {
            width: 100%;
            padding: 0.95rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }
        .btn-primary {
            background: var(--gold);
            color: var(--dark);
            box-shadow: 0 4px 14px rgba(255,184,0,0.28);
            margin-top: 0.4rem;
        }
        .btn-primary:hover:not(:disabled) { background: var(--yellow); transform: translateY(-1px); }
        .btn-primary:disabled { background: #ddd; color: #aaa; box-shadow: none; cursor: not-allowed; }
        .btn-secondary { background: #f0f0f0; color: var(--dark); }
        .btn-secondary:hover { background: #e4e4e4; }
        .btn-danger { background: var(--red); color: #fff; }
        .btn-danger:hover:not(:disabled) { background: #c0392b; }
        .btn-outline { background: #fff; border: 2px solid var(--gold); color: var(--dark); }
        .btn-outline:hover { background: #fff9e6; }

        /* â”€â”€ SCREENS â”€â”€ */
        .screen { display: none; }
        .screen.active { display: block; }

        /* â”€â”€ CONTRACT CARDS â”€â”€ */
        .contract-card {
            border: 2px solid #ebebeb;
            border-radius: 14px;
            padding: 1.2rem;
            margin-bottom: 0.9rem;
            cursor: pointer;
            transition: all 0.18s;
        }
        .contract-card:hover { border-color: var(--gold); background: #fffbf0; }
        .contract-card:active { transform: scale(0.99); }
        .cc-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.8rem;
            gap: 0.5rem;
        }
        .cc-product { font-weight: 800; font-size: 0.95rem; flex: 1; line-height: 1.3; }
        .badge {
            flex-shrink: 0;
            padding: 0.2rem 0.65rem;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 700;
            white-space: nowrap;
        }
        .badge-active   { background: #e8f5e9; color: var(--green); }
        .badge-pending  { background: #fff3e0; color: #e67e22; }
        .badge-expired  { background: #f0f0f0; color: #999; }
        .badge-cancelled{ background: #fde8e8; color: var(--red); }

        .cc-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem 0.8rem;
            font-size: 0.83rem;
        }
        .cc-meta-item { color: var(--gray); }
        .cc-meta-item strong { color: var(--dark); display: block; font-size: 0.88rem; }

        /* â”€â”€ DETAIL TABLE â”€â”€ */
        .detail-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .detail-table { width: 100%; border-collapse: collapse; }
        .detail-table tr { border-bottom: 1px solid #f0f0f0; }
        .detail-table tr:last-child { border-bottom: none; }
        .detail-table th {
            width: 36%;
            padding: 0.75rem 0.4rem;
            text-align: left;
            font-weight: 600;
            color: #999;
            font-size: 0.83rem;
            vertical-align: top;
        }
        .detail-table td {
            padding: 0.75rem 0.4rem;
            font-weight: 700;
            font-size: 0.92rem;
            vertical-align: top;
            word-break: break-all;
        }

        /* â”€â”€ ACTION GRID â”€â”€ */
        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-top: 1.4rem;
        }
        .action-btn {
            padding: 1rem 0.8rem;
            border-radius: 12px;
            border: 2px solid #e8e8e8;
            background: #fff;
            cursor: pointer;
            text-align: center;
            transition: all 0.18s;
            font-family: inherit;
            text-decoration: none;
            display: block;
        }
        .action-btn:hover { border-color: var(--gold); background: #fffbf0; }
        .action-btn:active { transform: scale(0.97); }
        .action-btn .ai { font-size: 1.6rem; display: block; margin-bottom: 0.3rem; }
        .action-btn .al { font-weight: 700; font-size: 0.85rem; color: var(--dark); display: block; }
        .action-btn .as { font-size: 0.72rem; color: var(--gray); margin-top: 0.15rem; display: block; }
        .action-btn.danger { border-color: #fca5a5; }
        .action-btn.danger:hover { border-color: var(--red); background: #fff5f5; }
        .action-btn.disabled { opacity: 0.38; cursor: not-allowed; pointer-events: none; }

        /* â”€â”€ BACK LINK â”€â”€ */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            color: var(--gray);
            font-size: 0.85rem;
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
            padding: 0.4rem 0;
            margin-bottom: 1rem;
        }
        .back-link:hover { color: var(--dark); }

        /* â”€â”€ NOTICE BOXES â”€â”€ */
        .notice {
            background: #fff9e6;
            border-left: 3px solid var(--gold);
            border-radius: 8px;
            padding: 0.9rem 1rem;
            margin: 0.9rem 0;
            font-size: 0.83rem;
            color: var(--gray);
            line-height: 1.65;
        }
        .notice strong { color: var(--dark); display: block; margin-bottom: 0.25rem; font-size: 0.88rem; }
        .warn {
            background: #fde8e8;
            border-left: 3px solid var(--red);
            border-radius: 8px;
            padding: 0.9rem 1rem;
            margin: 0.9rem 0;
            font-size: 0.83rem;
            color: #7d1a1a;
            line-height: 1.65;
        }
        .warn strong { display: block; margin-bottom: 0.25rem; font-weight: 800; }

        /* â”€â”€ SPINNER â”€â”€ */
        .spin {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2.5px solid rgba(0,0,0,0.12);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.65s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-wrap { text-align: center; padding: 2.5rem 0; }
        .loading-wrap p { color: var(--gray); margin-top: 0.8rem; font-size: 0.88rem; }
        .empty { text-align: center; padding: 2.5rem 0; }
        .empty-icon { font-size: 2.5rem; display: block; margin-bottom: 0.8rem; }
        .empty p { color: var(--gray); font-size: 0.88rem; }

        /* â”€â”€ MODAL â”€â”€ */
        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-bg.open { display: flex; }

        /* ëª¨ë°”ì¼ ë°”í…€ì‹œíŠ¸ ìŠ¤íƒ€ì¼ */
        .modal-sheet {
            background: #fff;
            border-radius: 22px 22px 0 0;
            padding: 1.6rem 1.4rem 2rem;
            width: 100%;
            max-width: 640px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            -webkit-overflow-scrolling: touch;
            animation: slideUp 0.28s ease;
        }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } }
        .modal-handle {
            width: 40px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin: 0 auto 1.2rem;
        }
        .modal-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 0.3rem; }
        .modal-sub   { color: var(--gray); font-size: 0.83rem; margin-bottom: 1.3rem; }
        .modal-close {
            position: absolute;
            top: 1.2rem;
            right: 1.2rem;
            background: #f0f0f0;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-footer { display: flex; gap: 0.7rem; margin-top: 1.3rem; }
        .modal-footer .btn { flex: 1; }

        /* ë“œë¡  í¸ì§‘ ì„¹ì…˜ */
        .drone-section {
            border: 2px solid #ebebeb;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.9rem;
        }
        .drone-section-title { font-weight: 800; color: var(--gold); margin-bottom: 0.9rem; font-size: 0.9rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem; }

        /* ê²°ê³¼ ëª¨ë‹¬ */
        .result-modal { text-align: center; }
        .result-icon  { font-size: 3rem; margin-bottom: 0.7rem; display: block; }
        .result-title { font-size: 1.2rem; font-weight: 900; margin-bottom: 0.4rem; }
        .result-msg   { color: var(--gray); font-size: 0.88rem; line-height: 1.6; }

        /* ê³„ì•½ ì •ë³´ ë¯¸ë‹ˆì¹´ë“œ */
        .contract-mini {
            background: var(--light);
            border-radius: 10px;
            padding: 0.9rem 1rem;
            font-size: 0.83rem;
            margin-bottom: 1rem;
        }
        .contract-mini-name { font-weight: 800; margin-bottom: 0.3rem; }
        .contract-mini-info { color: var(--gray); line-height: 1.6; }

        /* â”€â”€ FOOTER â”€â”€ */
        footer { background: var(--dark); color: #fff; padding: 1.5rem 1rem; margin-top: auto; }
        .footer-inner { max-width: 640px; margin: 0 auto; text-align: center; font-size: 0.78rem; color: #999; line-height: 1.7; }

        /* â”€â”€ RESPONSIVE â”€â”€ */
        @media (max-width: 480px) {
            .header-content { padding: 0.8rem 0.9rem; }
            .kb-logo { height: 32px; }
            .agency-name { font-size: 0.95rem; }
            .main { padding: 1.2rem 0.8rem 2.5rem; }
            .card { padding: 1.3rem 1.1rem; }
            .page-head h1 { font-size: 1.4rem; }
            .action-grid { grid-template-columns: 1fr 1fr; gap: 0.6rem; }
            .action-btn .ai { font-size: 1.4rem; }
            .action-btn .al { font-size: 0.8rem; }
            .form-row { grid-template-columns: 1fr; }
            .cc-meta { grid-template-columns: 1fr; }
            .modal-sheet { padding: 1.4rem 1.1rem 1.8rem; }
        }
        @media (max-width: 360px) {
            .agency-name { display: none; }
            .action-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- â•â• HEADER â•â• -->
<header>
    <div class="header-content">
        <div class="logo-section">
            <img src="kb-logo.png" alt="KBì†í•´ë³´í—˜" class="kb-logo">
            <div class="divider"></div>
            <div class="agency-name">ë°°ìƒì˜¨ ëŒ€ë¦¬ì </div>
        </div>
        <a href="/" class="back-home">ğŸ  í™ˆ</a>
    </div>
</header>

<div class="main">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SCREEN 1: ë³¸ì¸ì¸ì¦
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="screen active" id="screen-auth">
        <div class="page-head">
            <h1>ğŸ” ê³„ì•½ ì¡°íšŒ / ë³€ê²½</h1>
            <p>ê°€ì… ì‹œ ë“±ë¡í•˜ì‹  ì´ë¦„ê³¼ íœ´ëŒ€í° ë²ˆí˜¸ë¡œ<br>ë³¸ì¸ í™•ì¸ í›„ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="card">
            <div class="card-title">ë³¸ì¸ í™•ì¸</div>

            <div class="form-group">
                <label>ê°€ì…ì ì´ë¦„ *</label>
                <input type="text" id="a-name" placeholder="ì´ë¦„ ì…ë ¥" autocomplete="name" inputmode="text">
                <div class="field-err" id="err-name">ì´ë¦„ì„ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
            </div>

            <div class="form-group">
                <label>íœ´ëŒ€í° ë²ˆí˜¸ *</label>
                <div class="otp-row">
                    <input type="tel" id="a-phone" placeholder="010-0000-0000" maxlength="13" inputmode="numeric" autocomplete="tel">
                    <button class="otp-btn" id="otp-send-btn" onclick="sendOtp()">ì¸ì¦ë²ˆí˜¸ ë°›ê¸°</button>
                </div>
                <div class="field-err" id="err-phone">ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸(11ìë¦¬)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
            </div>

            <div id="otp-wrap" style="display:none;">
                <div class="form-group">
                    <label>ì¸ì¦ë²ˆí˜¸ *</label>
                    <div class="otp-row">
                        <input type="text" id="a-otp" placeholder="6ìë¦¬ ìˆ«ì" maxlength="6" inputmode="numeric" autocomplete="one-time-code">
                        <button class="otp-btn" id="otp-resend-btn" onclick="sendOtp(true)" style="display:none;">ì¬ë°œì†¡</button>
                    </div>
                    <div class="otp-timer" id="otp-timer"></div>
                    <div class="field-err" id="err-otp">ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                </div>
            </div>

            <div class="notice">
                <strong>ğŸ“Œ ì•ˆë‚´</strong>
                ë³¸ì¸ í™•ì¸ í›„ ë³´í—˜ ê³„ì•½ ì¡°íšŒ, ë“œë¡  ì •ë³´ ë³€ê²½,
                ê³„ì•½ ì·¨ì†Œ ë° í•´ì§€ë¥¼ ì§„í–‰í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <button class="btn btn-primary" id="auth-btn" onclick="doAuth()" disabled>ë³¸ì¸ í™•ì¸í•˜ê¸°</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SCREEN 2: ê³„ì•½ ëª©ë¡
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="screen" id="screen-list">
        <button class="back-link" onclick="goScreen('auth')">â† ë³¸ì¸ì¸ì¦ìœ¼ë¡œ</button>

        <div class="page-head" style="text-align:left; margin-bottom:1.2rem;">
            <h1 id="list-title">ğŸ“‹ ê°€ì… ì´ë ¥</h1>
            <p id="list-sub" style="font-size:0.88rem;"></p>
        </div>

        <div class="card" id="list-card">
            <div class="loading-wrap" id="list-loading">
                <div class="spin" style="width:32px;height:32px;border-width:3px;color:var(--gold);margin:0 auto;"></div>
                <p>ê³„ì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <div id="contract-list" style="display:none;"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SCREEN 3: ê³„ì•½ ìƒì„¸
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="screen" id="screen-detail">
        <button class="back-link" onclick="goScreen('list')">â† ê³„ì•½ ëª©ë¡ìœ¼ë¡œ</button>

        <div class="card">
            <div class="card-title" id="detail-title">ê³„ì•½ ìƒì„¸</div>
            <div class="detail-wrap">
                <table class="detail-table" id="detail-table"></table>
            </div>
            <div class="action-grid" id="action-grid"></div>
        </div>
    </div>

</div><!-- /main -->

<!-- â•â• FOOTER â•â• -->
<footer>
    <div class="footer-inner">
        <p>ğŸ“§ liab.on.ins@gmail.com | ğŸ“ ì„œìš¸ ë™ëŒ€ë¬¸êµ¬ ì²œí˜¸ëŒ€ë¡œ 301, 1706í˜¸</p>
        <p>ì‚¬ì—…ì 501-63-18916 | ëŒ€í‘œ ê¹€ë¦¬í•˜ | ëŒ€ë¦¬ì ë“±ë¡ë²ˆí˜¸ ì œ2026010037í˜¸</p>
        <p style="margin-top:0.5rem;opacity:0.45;">Â© 2026 ë°°ìƒì˜¨ ëŒ€ë¦¬ì  Â· KBì†í•´ë³´í—˜ ê³µì‹ ëŒ€ë¦¬ì </p>
    </div>
</footer>

<!-- â•â• MODAL: ë“œë¡  ì •ë³´ ë³€ê²½ â•â• -->
<div class="modal-bg" id="m-drone">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <button class="modal-close" onclick="closeModal('m-drone')">âœ•</button>
        <div class="modal-title">âœï¸ ë“œë¡  ì •ë³´ ë³€ê²½</div>
        <div class="modal-sub">ë³€ê²½í•  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ë‹´ë‹¹ì í™•ì¸ í›„ ì ìš©ë©ë‹ˆë‹¤.</div>
        <div id="drone-forms"></div>
        <div class="notice">
            <strong>ğŸ“Œ ë³€ê²½ ì•ˆë‚´</strong>
            ë³€ê²½ ìš”ì²­ í›„ 1~2 ì˜ì—…ì¼ ë‚´ ì²˜ë¦¬ë©ë‹ˆë‹¤.<br>
            ì²˜ë¦¬ ì™„ë£Œ ì‹œ ë“±ë¡ ì—°ë½ì²˜ë¡œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('m-drone')">ì·¨ì†Œ</button>
            <button class="btn btn-primary" id="drone-submit" onclick="submitDrone()">ë³€ê²½ ìš”ì²­</button>
        </div>
    </div>
</div>

<!-- â•â• MODAL: ê³„ì•½ ì·¨ì†Œ â•â• -->
<div class="modal-bg" id="m-cancel">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <button class="modal-close" onclick="closeModal('m-cancel')">âœ•</button>
        <div class="modal-title">ğŸš« ê³„ì•½ ì·¨ì†Œ</div>
        <div class="modal-sub">ë³´í—˜ ê°œì‹œ ì „ì—ë§Œ ì „ì•¡ í™˜ë¶ˆë¡œ ì·¨ì†Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        <div class="warn">
            <strong>âš ï¸ ì·¨ì†Œ ì „ í™•ì¸ì‚¬í•­</strong>
            ì·¨ì†Œ ì¦‰ì‹œ ë³´í—˜ íš¨ë ¥ì´ ì†Œë©¸ë©ë‹ˆë‹¤.<br>
            ì „ì•¡ í™˜ë¶ˆì€ 3~5 ì˜ì—…ì¼ ë‚´ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        </div>
        <div id="cancel-info"></div>
        <div class="form-group">
            <label>ì·¨ì†Œ ì‚¬ìœ  *</label>
            <select id="cancel-reason">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="change_mind">ë‹¨ìˆœ ë³€ì‹¬</option>
                <option value="duplicate">ì¤‘ë³µ ê°€ì…</option>
                <option value="info_error">ì •ë³´ ì…ë ¥ ì˜¤ë¥˜</option>
                <option value="other">ê¸°íƒ€</option>
            </select>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('m-cancel')">ëŒì•„ê°€ê¸°</button>
            <button class="btn btn-danger" onclick="submitCancel()">ì·¨ì†Œ í™•ì¸</button>
        </div>
    </div>
</div>

<!-- â•â• MODAL: ê³„ì•½ í•´ì§€ â•â• -->
<div class="modal-bg" id="m-term">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <button class="modal-close" onclick="closeModal('m-term')">âœ•</button>
        <div class="modal-title">ğŸ“¤ ê³„ì•½ í•´ì§€</div>
        <div class="modal-sub">ë³´í—˜ ê°œì‹œ í›„ ì¤‘ë„ í•´ì§€ë¥¼ ì‹ ì²­í•©ë‹ˆë‹¤.</div>
        <div class="warn">
            <strong>âš ï¸ í•´ì§€ ì „ í™•ì¸ì‚¬í•­</strong>
            í•´ì§€ í›„ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
            ë¯¸ê²½ê³¼ ë³´í—˜ë£ŒëŠ” ì¼í•  ê³„ì‚°í•˜ì—¬ í™˜ê¸‰ë©ë‹ˆë‹¤.
        </div>
        <div id="term-info"></div>
        <div class="form-group">
            <label>í•´ì§€ ì‚¬ìœ  *</label>
            <select id="term-reason">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="no_need">ë“œë¡  ë¯¸ì‚¬ìš©</option>
                <option value="sold">ë“œë¡  ì²˜ë¶„/ë§¤ë„</option>
                <option value="change_plan">íƒ€ ìƒí’ˆ ì „í™˜</option>
                <option value="other">ê¸°íƒ€</option>
            </select>
        </div>
        <div class="form-group">
            <label>í™˜ë¶ˆ ë°›ì„ ê³„ì¢Œ (ì„ íƒ)</label>
            <input type="text" id="term-bank" placeholder="ì˜ˆ: ì¹´ì¹´ì˜¤ë±…í¬ 3333-12-3456789">
            <div class="hint">ë¯¸ì…ë ¥ ì‹œ ì›ê²°ì œ ìˆ˜ë‹¨ìœ¼ë¡œ í™˜ë¶ˆë©ë‹ˆë‹¤.</div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('m-term')">ëŒì•„ê°€ê¸°</button>
            <button class="btn btn-danger" onclick="submitTerm()">í•´ì§€ ì‹ ì²­</button>
        </div>
    </div>
</div>

<!-- â•â• MODAL: ê²°ê³¼ â•â• -->
<div class="modal-bg" id="m-result">
    <div class="modal-sheet result-modal" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <div class="result-icon" id="r-icon"></div>
        <div class="result-title" id="r-title"></div>
        <div class="result-msg" id="r-msg"></div>
        <div class="notice" id="r-notice" style="text-align:left;display:none;"></div>
        <button class="btn btn-primary" onclick="closeModal('m-result')" style="margin-top:1.2rem;">í™•ì¸</button>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
    name: '', phone: '',
    otpSent: false, otpVerified: false,
    contracts: [], selected: null,
    timerInterval: null, timerSec: 180,
    mockOtp: '',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + id).classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT ì´ë²¤íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('a-phone').addEventListener('input', function() {
    let v = this.value.replace(/\D/g, '');
    if (v.length <= 3)       this.value = v;
    else if (v.length <= 7)  this.value = v.slice(0,3) + '-' + v.slice(3);
    else                     this.value = v.slice(0,3) + '-' + v.slice(3,7) + '-' + v.slice(7,11);
    checkAuth();
});
document.getElementById('a-name').addEventListener('input', checkAuth);
document.getElementById('a-otp').addEventListener('input', function() {
    this.value = this.value.replace(/\D/g,'').slice(0,6);
    checkAuth();
});

function checkAuth() {
    const name  = document.getElementById('a-name').value.trim();
    const phone = document.getElementById('a-phone').value.replace(/\D/g,'');
    const otp   = document.getElementById('a-otp').value.trim();
    // OTP ë°œì†¡ í›„ 6ìë¦¬ ì…ë ¥ ì™„ë£Œí•´ì•¼ë§Œ ë³¸ì¸í™•ì¸ ë²„íŠ¼ í™œì„±í™”
    const ok = S.otpSent && name.length >= 2 && phone.length === 11 && otp.length === 6;
    document.getElementById('auth-btn').disabled = !ok;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OTP ë°œì†¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendOtp(isResend = false) {
    const name  = document.getElementById('a-name').value.trim();
    const phone = document.getElementById('a-phone').value.replace(/\D/g,'');

    showErr('err-name',  name.length < 2);
    showErr('err-phone', phone.length !== 11);
    if (name.length < 2 || phone.length !== 11) return;

    const btn = document.getElementById('otp-send-btn');
    btn.disabled = true;
    btn.textContent = 'ë°œì†¡ ì¤‘...';

    try {
        const res  = await fetch('/api/my-insurance', {
            method:  'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'send_otp', name, phone }),
        });
        const data = await res.json();

        if (data.success) {
            S.name = name; S.phone = phone; S.otpSent = true;
            showOtpField(isResend);
        } else {
            showResult('âŒ', 'ë°œì†¡ ì‹¤íŒ¨', data.message || 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', null);
            btn.disabled = false;
            btn.textContent = 'ì¸ì¦ë²ˆí˜¸ ë°›ê¸°';
        }
    } catch(e) {
        // API í†µì‹  ì˜¤ë¥˜ ì‹œ ê°œë°œ Mock (í…ŒìŠ¤íŠ¸ìš©)
        console.warn('[Dev] API ë¯¸ì‘ë‹µ â†’ Mock OTP');
        S.name = name; S.phone = phone; S.otpSent = true;
        S.mockOtp = '123456';
        showOtpField(isResend);
        setTimeout(() => alert('ğŸ“± [ê°œë°œ ëª¨ë“œ] ì¸ì¦ë²ˆí˜¸: 123456\n(ìš´ì˜ ì‹œ ì†”ë¼í”¼ SMSë¡œ ë°œì†¡ë©ë‹ˆë‹¤)'), 200);
    }
    checkAuth();
}

function showOtpField(isResend) {
    document.getElementById('otp-wrap').style.display = 'block';
    document.getElementById('otp-send-btn').style.display = 'none';
    if (isResend) document.getElementById('otp-resend-btn').style.display = 'block';
    startTimer();
    document.getElementById('a-otp').focus();
}

function startTimer() {
    if (S.timerInterval) clearInterval(S.timerInterval);
    S.timerSec = 180;
    const el = document.getElementById('otp-timer');
    el.style.display = 'block';
    S.timerInterval = setInterval(() => {
        S.timerSec--;
        const m = Math.floor(S.timerSec / 60);
        const s = S.timerSec % 60;
        el.textContent = `ìœ íš¨ì‹œê°„: ${m}:${String(s).padStart(2,'0')}`;
        if (S.timerSec <= 0) {
            clearInterval(S.timerInterval);
            el.textContent = 'ë§Œë£Œë¨. ì¬ë°œì†¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
            document.getElementById('otp-resend-btn').style.display = 'block';
        }
    }, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë³¸ì¸ í™•ì¸ ì œì¶œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doAuth() {
    const otp  = document.getElementById('a-otp').value.trim();
    const btn  = document.getElementById('auth-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span> í™•ì¸ ì¤‘...';

    try {
        const res  = await fetch('/api/my-insurance', {
            method:  'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'verify_and_fetch',
                name:   S.name || document.getElementById('a-name').value.trim(),
                phone:  S.phone || document.getElementById('a-phone').value.replace(/\D/g,''),
                otp,
            }),
        });
        const data = await res.json();

        if (data.success) {
            clearInterval(S.timerInterval);
            S.name       = S.name || document.getElementById('a-name').value.trim();
            // API ì‘ë‹µì— ê³„ì•½ ì—†ê³  í…ŒìŠ¤íŠ¸ ê³„ì •ì´ë©´ Mock í‘œì‹œ
            const _phone = (S.phone||'').replace(/\D/g,'');
            const _name  = (S.name||'').trim();
            if (data.contracts && data.contracts.length > 0) {
                S.contracts = data.contracts;
            } else if (_name === 'ê¹€ë¦¬í•˜' && _phone === '01081862428') {
                S.contracts = getMockContracts();
            } else {
                S.contracts = data.contracts || [];
            }
            renderList();
            goScreen('list');
        } else {
            btn.disabled = false;
            btn.textContent = 'ë³¸ì¸ í™•ì¸í•˜ê¸°';
            showErr('err-otp', true, data.message);
        }
    } catch(e) {
        // API í†µì‹  ì˜¤ë¥˜ ì‹œ ê°œë°œ Mock fallback
        if (S.otpSent && otp !== S.mockOtp) {
            btn.disabled = false;
            btn.textContent = 'ë³¸ì¸ í™•ì¸í•˜ê¸°';
            showErr('err-otp', true, 'ì¸ì¦ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ê°œë°œëª¨ë“œ: 123456)');
            return;
        }
        clearInterval(S.timerInterval);
        S.name = S.name || document.getElementById('a-name').value.trim();
        // í…ŒìŠ¤íŠ¸ ê³„ì •(ê¹€ë¦¬í•˜ / 01081862428)ì¼ ë•Œë§Œ Mock ë°ì´í„° í‘œì‹œ
        const testPhone = (S.phone || document.getElementById('a-phone').value.replace(/\D/g,'')).replace(/\D/g,'');
        const testName  = S.name.trim();
        if (testName === 'ê¹€ë¦¬í•˜' && testPhone === '01081862428') {
            S.contracts = getMockContracts();
        } else {
            S.contracts = [];
        }
        renderList();
        goScreen('list');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOCK DATA (í…ŒìŠ¤íŠ¸ìš© - ê¹€ë¦¬í•˜ / 01081862428 ì „ìš©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getMockContracts() {
    const fmt  = d => d.toISOString().split('T')[0];
    const add  = (d, y) => { const r=new Date(d); r.setFullYear(r.getFullYear()+y); return r; };
    const now  = new Date();
    return [
        {
            id: 'KBD-20260001', product: 'KBì†í•´ë³´í—˜ ê°œì¸ìš© ë“œë¡ ë³´í—˜',
            status: 'pending', plan: 'ì¼ë°˜ (camera-standard)',
            start_date: fmt(add(now,0)), end_date: fmt(add(now,1)),
            total_premium: 69900, created_at: fmt(now),
            drones: [{ index:0, model:'DJI Mini 3 Pro', serial:'ABC123456', type:'camera', type_name:'ì´¬ì˜ìš© ë“œë¡ ', weight:'0.249', max_weight:'0.249' }],
            can_cancel: true, can_terminate: false,
        },
        {
            id: 'KBD-20250088', product: 'KBì†í•´ë³´í—˜ ê°œì¸ìš© ë“œë¡ ë³´í—˜',
            status: 'expired', plan: 'ìŠ¬ë¦¼ (fpv-slim)',
            start_date: fmt(add(now,-2)), end_date: fmt(add(now,-1)),
            total_premium: 59900, created_at: fmt(add(now,-2)),
            drones: [{ index:0, model:'Geprc Mark5', serial:'XYZ789', type:'fpv', type_name:'FPV ë“œë¡ ', weight:'0.8', max_weight:'0.9' }],
            can_cancel: false, can_terminate: false,
        },
    ];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIST RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BADGE = { active:'badge-active', pending:'badge-pending', expired:'badge-expired', cancelled:'badge-cancelled' };
const LABEL = { active:'ë³´ì¥ ì¤‘', pending:'ê°œì‹œ ì „', expired:'ë§Œê¸°', cancelled:'ì·¨ì†Œë¨' };

function renderList() {
    document.getElementById('list-title').textContent = 'ğŸ“‹ ê°€ì… ì´ë ¥';
    document.getElementById('list-sub').textContent   = `${S.name}ë‹˜ Â· ì´ ${S.contracts.length}ê±´`;

    const loading = document.getElementById('list-loading');
    const list    = document.getElementById('contract-list');
    loading.style.display = 'none';
    list.style.display    = 'block';

    if (!S.contracts.length) {
        list.innerHTML = `<div class="empty"><span class="empty-icon">ğŸ“­</span><p>ê°€ì…ëœ ê³„ì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p><p style="margin-top:.4rem;font-size:.8rem;">ë‹¤ë¥¸ ì´ë¦„ì´ë‚˜ ë²ˆí˜¸ë¡œ ì¡°íšŒí•´ë³´ì„¸ìš”.</p></div>`;
        return;
    }

    list.innerHTML = S.contracts.map((c, i) => `
        <div class="contract-card" onclick="selectContract(${i})">
            <div class="cc-top">
                <div class="cc-product">${c.product}</div>
                <span class="badge ${BADGE[c.status]||'badge-expired'}">${LABEL[c.status]||c.status}</span>
            </div>
            <div class="cc-meta">
                <div class="cc-meta-item"><strong>${c.id}</strong>ì¦ê¶Œë²ˆí˜¸</div>
                <div class="cc-meta-item"><strong>${c.plan}</strong>í”Œëœ</div>
                <div class="cc-meta-item"><strong>${c.start_date}~${c.end_date}</strong>ë³´í—˜ê¸°ê°„</div>
                <div class="cc-meta-item"><strong>${c.total_premium.toLocaleString()}ì›</strong>ì—°ê°„ ë³´í—˜ë£Œ</div>
            </div>
        </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETAIL RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectContract(i) {
    S.selected = S.contracts[i];
    renderDetail(S.selected);
    goScreen('detail');
}

function renderDetail(c) {
    document.getElementById('detail-title').innerHTML =
        `ğŸ“„ ${c.product} <span class="badge ${BADGE[c.status]||''}" style="font-size:.72rem">${LABEL[c.status]||c.status}</span>`;

    const droneRows = c.drones.map((d, i) => `
        <tr><th>ë“œë¡  ${i+1}</th><td>${d.model}</td></tr>
        <tr><th>ì¢…ë¥˜</th><td>${d.type_name}</td></tr>
        <tr><th>ì‹œë¦¬ì–¼</th><td>${d.serial}</td></tr>
        <tr><th>ìì²´ì¤‘ëŸ‰</th><td>${d.weight} kg</td></tr>
        <tr><th>ìµœëŒ€ì´ë¥™</th><td>${d.max_weight} kg</td></tr>
        ${i < c.drones.length-1 ? '<tr><td colspan="2" style="height:6px"></td></tr>' : ''}
    `).join('');

    document.getElementById('detail-table').innerHTML = `
        <tr><th>ì¦ê¶Œë²ˆí˜¸</th><td style="color:var(--gold);font-weight:900">${c.id}</td></tr>
        <tr><th>í”Œëœ</th><td>${c.plan}</td></tr>
        <tr><th>ë³´í—˜ê¸°ê°„</th><td>${c.start_date}<br>~ ${c.end_date}</td></tr>
        <tr><th>ì—°ê°„ ë³´í—˜ë£Œ</th><td style="font-weight:900">${c.total_premium.toLocaleString()}ì›</td></tr>
        <tr><th>ë“œë¡  ìˆ˜</th><td>${c.drones.length}ëŒ€</td></tr>
        ${droneRows}
        <tr><th>ê°€ì…ì¼</th><td>${c.created_at}</td></tr>`;

    const isActive  = c.status === 'active';
    const isPending = c.status === 'pending';
    const canEdit   = isActive || isPending;

    document.getElementById('action-grid').innerHTML = `
        <button class="action-btn ${canEdit?'':'disabled'}" onclick="${canEdit?"openModal('m-drone')":"''"}">
            <span class="ai">ğŸš</span><span class="al">ë“œë¡  ì •ë³´ ë³€ê²½</span><span class="as">ëª¨ë¸Â·ì‹œë¦¬ì–¼ ìˆ˜ì •</span>
        </button>
        <button class="action-btn ${isPending?'danger':'disabled'}" onclick="${isPending?"openModal('m-cancel')":"''"}">
            <span class="ai">ğŸš«</span><span class="al">ê³„ì•½ ì·¨ì†Œ</span><span class="as">ê°œì‹œ ì „ ì „ì•¡í™˜ë¶ˆ</span>
        </button>
        <button class="action-btn ${isActive?'danger':'disabled'}" onclick="${isActive?"openModal('m-term')":"''"}">
            <span class="ai">ğŸ“¤</span><span class="al">ê³„ì•½ í•´ì§€</span><span class="as">ë¯¸ê²½ê³¼ë³´í—˜ë£Œ í™˜ë¶ˆ</span>
        </button>
        <a href="/claims" class="action-btn">
            <span class="ai">ğŸ“®</span><span class="al">ë³´í—˜ê¸ˆ ì²­êµ¬</span><span class="as">ì‚¬ê³  ì ‘ìˆ˜ ì•ˆë‚´</span>
        </a>`;

    // ë“œë¡  í¸ì§‘ í¼
    buildDroneForms(c.drones);

    // ì·¨ì†ŒÂ·í•´ì§€ ê³„ì•½ ë¯¸ë‹ˆì¹´ë“œ
    const mini = `<div class="contract-mini">
        <div class="contract-mini-name">${c.product}</div>
        <div class="contract-mini-info">ì¦ê¶Œë²ˆí˜¸: ${c.id}<br>ë³´í—˜ê¸°ê°„: ${c.start_date} ~ ${c.end_date}<br>ë³´í—˜ë£Œ: ${c.total_premium.toLocaleString()}ì›</div>
    </div>`;
    document.getElementById('cancel-info').innerHTML = mini;
    document.getElementById('term-info').innerHTML   = mini;
}

function buildDroneForms(drones) {
    document.getElementById('drone-forms').innerHTML = drones.map((d, i) => `
        <div class="drone-section">
            <div class="drone-section-title">ğŸš ë“œë¡  ${i+1}</div>
            <div class="form-group">
                <label>ëª¨ë¸ëª…</label>
                <input type="text" id="em-${i}" value="${d.model}" placeholder="ì˜ˆ: DJI Mini 3 Pro">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ì‹œë¦¬ì–¼ë²ˆí˜¸</label>
                    <input type="text" id="es-${i}" value="${d.serial}" placeholder="ì‹œë¦¬ì–¼ë²ˆí˜¸">
                </div>
                <div class="form-group">
                    <label>ë“œë¡  ì¢…ë¥˜</label>
                    <select id="et-${i}">
                        <option value="camera" ${d.type==='camera'?'selected':''}>ì´¬ì˜ìš©</option>
                        <option value="fpv"    ${d.type==='fpv'?'selected':''}>FPV/ë ˆì´ì‹±</option>
                        <option value="toy"    ${d.type==='toy'?'selected':''}>ì™„êµ¬í˜•</option>
                        <option value="other"  ${d.type==='other'?'selected':''}>ê¸°íƒ€</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ìì²´ì¤‘ëŸ‰(kg)</label>
                    <input type="number" id="ew-${i}" value="${d.weight}" min="0.001" step="0.001" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label>ìµœëŒ€ì´ë¥™ì¤‘ëŸ‰(kg)</label>
                    <input type="number" id="emw-${i}" value="${d.max_weight}" min="0.001" step="0.001" inputmode="decimal">
                </div>
            </div>
        </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) {
    document.getElementById(id).classList.add('open');
    document.body.style.overflow = 'hidden';
}
function closeModal(id) {
    document.getElementById(id).classList.remove('open');
    document.body.style.overflow = '';
}
// ë°°ê²½ íƒ­ìœ¼ë¡œ ë‹«ê¸°
document.querySelectorAll('.modal-bg').forEach(bg => {
    bg.addEventListener('click', function(e) {
        if (e.target === this) closeModal(this.id);
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBMIT: ë“œë¡  ë³€ê²½
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitDrone() {
    const c = S.selected;
    if (!c) return;
    const changes = c.drones.map((d, i) => ({
        index: i,
        model: document.getElementById(`em-${i}`)?.value.trim()  || d.model,
        serial: document.getElementById(`es-${i}`)?.value.trim() || d.serial,
        type:  document.getElementById(`et-${i}`)?.value         || d.type,
        weight: document.getElementById(`ew-${i}`)?.value        || d.weight,
        max_weight: document.getElementById(`emw-${i}`)?.value   || d.max_weight,
    }));
    const btn = document.getElementById('drone-submit');
    btn.disabled = true; btn.innerHTML = '<span class="spin"></span> ì²˜ë¦¬ ì¤‘...';
    try {
        const res = await fetch('/api/my-insurance', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ action:'change_drone_info', name:S.name, phone:S.phone, contract_id:c.id, changes }),
        });
        const data = await res.json();
        closeModal('m-drone');
        showResult(data.success?'âœ…':'âŒ', data.success?'ë³€ê²½ ìš”ì²­ ì™„ë£Œ':'ìš”ì²­ ì‹¤íŒ¨',
            data.message, data.success?'ë‹´ë‹¹ìê°€ 1~2 ì˜ì—…ì¼ ë‚´ ì²˜ë¦¬í•´ë“œë¦½ë‹ˆë‹¤.':null);
    } catch {
        closeModal('m-drone');
        showResult('âœ…','ë³€ê²½ ìš”ì²­ ì ‘ìˆ˜','ë“œë¡  ì •ë³´ ë³€ê²½ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.','ë‹´ë‹¹ìê°€ 1~2 ì˜ì—…ì¼ ë‚´ ì—°ë½ë“œë¦½ë‹ˆë‹¤.');
    } finally { btn.disabled=false; btn.textContent='ë³€ê²½ ìš”ì²­'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBMIT: ì·¨ì†Œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitCancel() {
    const reason = document.getElementById('cancel-reason').value;
    if (!reason) { alert('ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    if (!confirm('ì •ë§ë¡œ ê³„ì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const c = S.selected;
    try {
        const res = await fetch('/api/my-insurance', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ action:'cancel_contract', name:S.name, phone:S.phone, contract_id:c.id, reason }),
        });
        const data = await res.json();
        closeModal('m-cancel');
        c.status = 'cancelled'; c.can_cancel = false; c.can_terminate = false;
        renderList();
        showResult('âœ…','ì·¨ì†Œ ì™„ë£Œ', data.message||'ê³„ì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'í™˜ë¶ˆì€ 3~5 ì˜ì—…ì¼ ë‚´ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
    } catch {
        closeModal('m-cancel');
        c.status = 'cancelled'; renderList();
        showResult('âœ…','ì·¨ì†Œ ìš”ì²­ ì ‘ìˆ˜','ê³„ì•½ ì·¨ì†Œ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.','í™˜ë¶ˆì€ 3~5 ì˜ì—…ì¼ ë‚´ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBMIT: í•´ì§€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitTerm() {
    const reason = document.getElementById('term-reason').value;
    const bank   = document.getElementById('term-bank').value.trim();
    if (!reason) { alert('í•´ì§€ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    if (!confirm('ì •ë§ë¡œ ê³„ì•½ì„ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•´ì§€ í›„ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
    const c = S.selected;
    try {
        const res = await fetch('/api/my-insurance', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ action:'terminate_contract', name:S.name, phone:S.phone, contract_id:c.id, reason, refund_account:bank }),
        });
        const data = await res.json();
        closeModal('m-term');
        c.status = 'cancelled'; renderList();
        showResult('âœ…','í•´ì§€ ì‹ ì²­ ì™„ë£Œ', data.message||'í•´ì§€ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.','ë¯¸ê²½ê³¼ ë³´í—˜ë£ŒëŠ” 5~7 ì˜ì—…ì¼ ë‚´ í™˜ë¶ˆë©ë‹ˆë‹¤.');
    } catch {
        closeModal('m-term');
        c.status = 'cancelled'; renderList();
        showResult('âœ…','í•´ì§€ ìš”ì²­ ì ‘ìˆ˜','ê³„ì•½ í•´ì§€ ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.','ë¯¸ê²½ê³¼ ë³´í—˜ë£ŒëŠ” 5~7 ì˜ì—…ì¼ ë‚´ í™˜ë¶ˆë©ë‹ˆë‹¤.');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê²°ê³¼ ëª¨ë‹¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResult(icon, title, msg, notice) {
    document.getElementById('r-icon').textContent  = icon;
    document.getElementById('r-title').textContent = title;
    document.getElementById('r-msg').textContent   = msg || '';
    const n = document.getElementById('r-notice');
    if (notice) { n.style.display='block'; n.innerHTML=`<strong>ğŸ“Œ ì•ˆë‚´</strong>${notice}`; }
    else        { n.style.display='none'; }
    openModal('m-result');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì—ëŸ¬ í—¬í¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showErr(id, show, msg) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('show', !!show);
    if (msg) el.textContent = msg;
}
</script>
</body>
</html>
