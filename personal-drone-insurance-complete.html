<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²¬ì ì„œ í™•ì¸ - KBì†í•´ë³´í—˜ ê°œì¸ìš© ë“œë¡ ë³´í—˜</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --kb-yellow: #FFCD00; --kb-gold: #FFB800; --kb-dark: #1a1a1a; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            color: var(--kb-dark);
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-content {
            max-width: 1200px; margin: 0 auto;
            padding: 1.5rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo-section { display: flex; align-items: center; gap: 1.5rem; }
        .kb-logo { height: 50px; }
        .divider { height: 40px; width: 1px; background: #ddd; }
        .agency-name { font-size: 1.5rem; font-weight: 700; color: var(--kb-dark); }
        .home-btn {
            padding: 0.7rem 1.3rem; background: var(--kb-gold); color: var(--kb-dark);
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
            transition: all 0.3s; text-decoration: none; display: inline-block; font-size: 0.95rem;
        }
        .home-btn:hover { background: var(--kb-yellow); transform: translateY(-2px); }
        .main-content {
            flex: 1; display: flex; align-items: center;
            justify-content: center; padding: 3rem 2rem;
        }
        .complete-card {
            background: #fff; border-radius: 30px;
            padding: 4rem 3rem; max-width: 800px; width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .title-section { text-align: center; margin-bottom: 3rem; }
        .success-icon {
            width: 80px; height: 80px; background: var(--kb-gold);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem;
        }
        .complete-title { font-size: 2rem; font-weight: 900; margin-bottom: 0.5rem; color: var(--kb-dark); }
        .complete-subtitle { font-size: 1rem; color: #666; }
        .quote-box { background: #f8f9fa; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; }
        .quote-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--kb-gold); }
        .info-row { display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid #e0e0e0; }
        .info-row:last-child { border-bottom: none; }
        .info-label { font-weight: 600; color: #666; }
        .info-value { font-weight: 700; color: var(--kb-dark); }
        .total-price { background: var(--kb-gold); padding: 1.5rem; border-radius: 12px; text-align: center; margin: 2rem 0; }
        .total-price-label { font-size: 1rem; margin-bottom: 0.5rem; }
        .total-price-value { font-size: 2.5rem; font-weight: 900; color: var(--kb-dark); }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .navigation-buttons { display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; }
        .btn { padding: 1.2rem; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-pdf { background: #e74c3c; color: #fff; }
        .btn-pdf:hover { background: #c0392b; transform: translateY(-2px); }
        .btn-email { background: var(--kb-gold); color: var(--kb-dark); }
        .btn-email:hover { background: var(--kb-yellow); transform: translateY(-2px); }
        .btn-email:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-back { background: #e0e0e0; color: var(--kb-dark); }
        .btn-back:hover { background: #d0d0d0; }
        .btn-payment { background: var(--kb-dark); color: #fff; }
        .btn-payment:hover { background: #000; transform: translateY(-2px); }
        .notice { background: #fff9e6; padding: 1.5rem; border-radius: 12px; margin-top: 2rem; font-size: 0.95rem; color: #666; }
        .notice strong { color: var(--kb-dark); display: block; margin-bottom: 0.5rem; }
        footer { background: var(--kb-dark); color: #fff; padding: 2rem; }
        .footer-content { max-width: 1200px; margin: 0 auto; text-align: center; font-size: 0.9rem; opacity: 0.8; }

        @media (max-width: 768px) {
            .main-content { padding: 1.5rem 1rem; }
            .complete-card { padding: 2rem 1.5rem; border-radius: 20px; }
            .complete-title { font-size: 1.5rem; }
            .complete-subtitle { font-size: 0.9rem; }
            .success-icon { width: 64px; height: 64px; font-size: 2rem; }
            .total-price-value { font-size: 2rem; }
            .action-buttons, .navigation-buttons { grid-template-columns: 1fr; }
            .btn { padding: 1rem; font-size: 1rem; }
            .info-label, .info-value { font-size: 0.9rem; }
            .quote-title { font-size: 1.1rem; }
        }
        @media (max-width: 480px) {
            .main-content { padding: 1rem 0.75rem; }
            .complete-card { padding: 1.5rem 1rem; border-radius: 16px; }
            .complete-title { font-size: 1.3rem; }
            .total-price-value { font-size: 1.7rem; }
            .total-price-label { font-size: 0.85rem; }
            .total-price { padding: 1rem; }
            .quote-box { padding: 1.2rem; }
            .info-row { flex-direction: column; gap: 0.2rem; padding: 0.6rem 0; }
            .info-label { color: #999; font-size: 0.8rem; }
            .info-value { font-size: 0.95rem; }
            .notice { padding: 1rem; font-size: 0.85rem; }
            .btn { padding: 0.9rem; font-size: 0.95rem; border-radius: 10px; }
            .header-content { padding: 1rem; }
            .agency-name { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="logo-section">
            <img src="kb-logo.png" alt="KBì†í•´ë³´í—˜" class="kb-logo">
            <div class="divider"></div>
            <div class="agency-name">ë°°ìƒì˜¨ ëŒ€ë¦¬ì </div>
        </div>
        <a href="/personal-drone-insurance" class="home-btn">ğŸ  í™ˆìœ¼ë¡œ</a>
    </div>
</header>

<div class="main-content">
    <div class="complete-card">
        <div class="title-section">
            <div class="success-icon">ğŸ“‹</div>
            <h1 class="complete-title">ê²¬ì ì„œ í™•ì¸</h1>
            <p class="complete-subtitle">ì…ë ¥í•˜ì‹  ì •ë³´ë¥¼ í™•ì¸í•˜ì‹œê³  ê²¬ì ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ì´ë©”ì¼ë¡œ ë°›ì•„ë³´ì„¸ìš”</p>
        </div>

        <div class="quote-box">
            <h2 class="quote-title">ë³´í—˜ ì •ë³´</h2>
            <div id="insuranceInfo"></div>
        </div>

        <div class="total-price">
            <div class="total-price-label">ì´ ë³´í—˜ë£Œ</div>
            <div class="total-price-value" id="totalPrice">0ì›</div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-pdf" onclick="downloadPDF()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-email" onclick="sendEmail()">ğŸ“§ ì´ë©”ì¼ ì „ì†¡</button>
        </div>

        <div class="navigation-buttons">
            <button class="btn btn-back" onclick="history.back()">ì´ì „</button>
            <button class="btn btn-payment" onclick="alert('ê²°ì œ ì—°ë™ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì´ë©”ì¼ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.')">ğŸ’³ ê²°ì œí•˜ê¸°</button>
        </div>

        <div class="notice">
            <strong>ì•ˆë‚´ì‚¬í•­</strong>
            â€¢ ê²¬ì ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ì´ë©”ì¼ë¡œ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
            â€¢ ê°€ì…ì„ ì›í•˜ì‹œë©´ ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br>
            â€¢ ê²¬ì ì„œëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ë³´í—˜ë£ŒëŠ” ì‹¬ì‚¬ í›„ í™•ì •ë©ë‹ˆë‹¤.<br>
            â€¢ ë¬¸ì˜ì‚¬í•­: <span id="contactEmail"></span>
        </div>
    </div>
</div>

<footer>
    <div class="footer-content">
        <p>Â© 2026 ë°°ìƒì˜¨ ëŒ€ë¦¬ì . All rights reserved. | KBì†í•´ë³´í—˜ ê³µì‹ ëŒ€ë¦¬ì </p>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
/* ===========================================
   ì „ì—­ ë³€ìˆ˜
=========================================== */
var insuranceData = null;
// Cloudflare ì´ë©”ì¼ ë‚œë…í™” ë°©ì§€
var CONTACT_EMAIL = 'liab.on.ins' + '@' + 'gmail.com';

/* ===========================================
   í˜ì´ì§€ ì´ˆê¸°í™”
=========================================== */
window.addEventListener('DOMContentLoaded', function () {
    // ì´ë©”ì¼ ì£¼ì†Œ ì‚½ì… (Cloudflare ë‚œë…í™” ë°©ì§€)
    var emailEl = document.getElementById('contactEmail');
    if (emailEl) {
        var link = document.createElement('a');
        link.href = 'mailto:' + CONTACT_EMAIL;
        link.textContent = CONTACT_EMAIL;
        link.style.color = '#666';
        emailEl.appendChild(link);
    }

    // sessionStorage ë¡œë“œ
    var savedData = '';
    try { savedData = sessionStorage.getItem('droneInsuranceData') || ''; } catch (e) { }

    if (!savedData) {
        document.getElementById('insuranceInfo').innerHTML =
            '<p style="color:#e74c3c;text-align:center;padding:1.5rem;line-height:2.4;">' +
            'ì €ì¥ëœ ë³´í—˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.<br>' +
            '<a href="/personal-drone-insurance" style="color:#FFB800;font-weight:700;">ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</a></p>';
        return;
    }

    try {
        insuranceData = JSON.parse(savedData);
    } catch (e) {
        document.getElementById('insuranceInfo').innerHTML =
            '<p style="color:#e74c3c;text-align:center;padding:1rem;">' +
            'ë°ì´í„° ì˜¤ë¥˜. <a href="/personal-drone-insurance" style="color:#FFB800;">ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘</a></p>';
        return;
    }

    displayInfo();
});

/* ===========================================
   ë³´í—˜ ì •ë³´ í™”ë©´ í‘œì‹œ
=========================================== */
function displayInfo() {
    var container = document.getElementById('insuranceInfo');
    if (!container || !insuranceData) return;

    var droneTypes = {
        'camera': 'ì´¬ì˜ìš© ì„¼ì„œë“œë¡ ',
        'fpv': 'FPV/ë ˆì´ì‹± ë“œë¡ ',
        'toy': 'ì™„êµ¬í˜• ë“œë¡ ',
        'other': 'ê¸°íƒ€ ë“œë¡ '
    };

    function fmtDT(s) {
        if (!s) return 'ë¯¸ì…ë ¥';
        var p = s.split('T');
        return p[0] + (p[1] ? ' (' + p[1] + ')' : '');
    }

    function infoRow(label, value) {
        return '<div class="info-row">' +
               '<span class="info-label">' + label + '</span>' +
               '<span class="info-value">' + (value || 'ë¯¸ì…ë ¥') + '</span>' +
               '</div>';
    }
    function infoRowColor(label, value, color) {
        return '<div class="info-row">' +
               '<span class="info-label">' + label + '</span>' +
               '<span class="info-value" style="color:' + color + ';">' + (value || 'ë¯¸ì…ë ¥') + '</span>' +
               '</div>';
    }

    var html = '';
    html += infoRow('ê°€ì…ìëª…', insuranceData.name);
    html += infoRow('ì—°ë½ì²˜',   insuranceData.phone);
    html += infoRow('ì´ë©”ì¼',   insuranceData.email);
    html += infoRow('ë³´í—˜ê¸°ê°„', fmtDT(insuranceData.insurance_start) + ' ~ ' + fmtDT(insuranceData.insurance_end));
    html += infoRow('ë“œë¡  ëŒ€ìˆ˜', (insuranceData.drone_count || 1) + 'ëŒ€');

    if (insuranceData.drone_plans && insuranceData.drone_plans.length > 0) {
        insuranceData.drone_plans.forEach(function (p, i) {
            var d = (insuranceData.drones || [])[i] || {};
            var typeName = p.drone_type_name || droneTypes[p.drone_type] || droneTypes[d.type] || 'ë¯¸ì…ë ¥';
            html += '<div style="margin:1.2rem 0;padding:1.2rem;background:#f0f4ff;border-radius:10px;border-left:4px solid #FFB800;">';
            html += '<div style="font-weight:700;color:#FFB800;margin-bottom:0.6rem;">ë“œë¡  ' + (i + 1) + '</div>';
            html += infoRow('ëª¨ë¸ëª…',    d.model || 'ë¯¸ì…ë ¥');
            html += infoRow('ë“œë¡  ì¢…ë¥˜', typeName);
            html += infoRow('ì„ íƒ í”Œëœ', p.plan_name || 'ë¯¸ì…ë ¥');
            html += infoRowColor('ë³´í—˜ë£Œ', parseInt(p.price || 0).toLocaleString() + 'ì›/ë…„', '#FFB800');
            html += '</div>';
        });
    } else {
        html += infoRow('ë“œë¡  ì¢…ë¥˜',    droneTypes[insuranceData.drone_type] || 'ë¯¸ì…ë ¥');
        html += infoRow('ì„ íƒ í”Œëœ',    insuranceData.plan_name || 'ë¯¸ì…ë ¥');
        html += infoRow('ë³´í—˜ë£Œ(1ëŒ€ë‹¹)', parseInt(insuranceData.plan_price_per_drone || 0).toLocaleString() + 'ì›/ë…„');
    }

    container.innerHTML = html;

    var total = parseInt(insuranceData.plan_total_price || insuranceData.total_price || 0);
    document.getElementById('totalPrice').textContent = total.toLocaleString() + 'ì›';
}

/* ===========================================
   ë³´ì¥ ë‚´ìš© ê³„ì‚° (PDFìš©)
=========================================== */
function getCoverageInfo(plan) {
    if (!plan) return { personal: 'ë¯¸ì…ë ¥', property: 'ë¯¸ì…ë ¥', additional: 'ë¯¸ì…ë ¥' };
    var c = { personal: '', property: '', additional: '' };

    if      (plan.indexOf('slim') !== -1)     { c.personal = '5,000ë§Œì›';  c.property = '5,000ë§Œì›'; }
    else if (plan.indexOf('standard') !== -1) { c.personal = '1ì–µì›';      c.property = '1ì–µì›'; }
    else if (plan.indexOf('premium') !== -1)  { c.personal = '5ì–µì›';      c.property = '5ì–µì›'; }

    if (plan.indexOf('camera') !== -1) {
        if      (plan.indexOf('slim') !== -1)     c.additional = 'ê¸°ë³¸ì¶©ì‹¤';
        else if (plan.indexOf('standard') !== -1) c.additional = 'ëˆ„êµ¬ë‚˜ìš´ì „ í¬í•¨';
        else if (plan.indexOf('premium') !== -1)  c.additional = 'ëˆ„êµ¬ë‚˜ìš´ì „+êµ¬ì¡°ë¹„ìš©';
    } else if (plan.indexOf('fpv') !== -1) {
        if      (plan.indexOf('slim') !== -1)     c.additional = 'ë“œë¡ ê²½ê¸°ì¤‘ ë³´ì¥';
        else if (plan.indexOf('standard') !== -1) c.additional = 'ê²½ê¸°ì¤‘+ëˆ„êµ¬ë‚˜ìš´ì „';
        else if (plan.indexOf('premium') !== -1)  c.additional = 'ê²½ê¸°ì¤‘+ëˆ„êµ¬ë‚˜ìš´ì „+êµ¬ì¡°';
    } else {
        if      (plan.indexOf('slim') !== -1)     c.additional = 'ê¸°ë³¸ë³´ì¥';
        else if (plan.indexOf('standard') !== -1) c.additional = 'ëˆ„êµ¬ë‚˜ìš´ì „ í¬í•¨';
        else if (plan.indexOf('premium') !== -1)  c.additional = 'ëˆ„êµ¬ë‚˜ìš´ì „+êµ¬ì¡°ë¹„ìš©';
    }
    return c;
}

/* ===========================================
   PDF ë‹¤ìš´ë¡œë“œ
   - html2pdf + html2canvas ëŠ” display:grid, CSS gradient ì¼ë¶€ ë¯¸ì§€ì›
   - í•´ê²°: ëª¨ë“  ë ˆì´ì•„ì›ƒì„ <table> ë¡œ, ìƒ‰ìƒë°°ê²½ì€ ë‹¨ìƒ‰ bgcolor ì†ì„±ìœ¼ë¡œ
=========================================== */
async function downloadPDF() {
    if (!insuranceData) {
        alert('ë³´í—˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    var pdfBtn = document.querySelector('.btn-pdf');
    pdfBtn.disabled = true;
    pdfBtn.textContent = 'ìƒì„± ì¤‘...';

    var droneTypes = {
        'camera': 'ì´¬ì˜ìš© ì„¼ì„œë“œë¡ ',
        'fpv': 'FPV/ë ˆì´ì‹± ë“œë¡ ',
        'toy': 'ì™„êµ¬í˜• ë“œë¡ ',
        'other': 'ê¸°íƒ€ ë“œë¡ '
    };

    function fmtDT(s) {
        if (!s) return 'ë¯¸ì…ë ¥';
        var p = s.split('T');
        return p[0] + (p[1] ? ' (' + p[1] + ')' : '');
    }

    var today   = new Date();
    var dateStr = today.getFullYear() + 'ë…„ ' + (today.getMonth() + 1) + 'ì›” ' + today.getDate() + 'ì¼';
    var total   = parseInt(insuranceData.plan_total_price || insuranceData.total_price || 0);

    // â”€â”€ ë“œë¡ ë³„ í–‰ ìƒì„± (table tr ë°©ì‹) â”€â”€
    var droneRows = '';
    if (insuranceData.drone_plans && insuranceData.drone_plans.length > 0) {
        insuranceData.drone_plans.forEach(function (p, i) {
            var d   = (insuranceData.drones || [])[i] || {};
            var cov = getCoverageInfo(p.plan);
            var typeName = p.drone_type_name || droneTypes[p.drone_type] || droneTypes[d.type] || 'ë¯¸ì…ë ¥';

            droneRows +=
                '<tr><td colspan="4" style="background:#FFB800;padding:5px 10px;font-weight:700;font-size:10px;color:#1a1a1a;">&#x1F681; ë“œë¡  ' + (i + 1) + '</td></tr>' +
                '<tr style="background:#f8f8f8;">' +
                    '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ëª¨ë¸ëª…</td>' +
                    '<td style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + (d.model || 'ë¯¸ì…ë ¥') + '</td>' +
                    '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ë“œë¡  ì¢…ë¥˜</td>' +
                    '<td style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + typeName + '</td>' +
                '</tr>' +
                '<tr style="background:#fff;">' +
                    '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ì„ íƒ í”Œëœ</td>' +
                    '<td style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + (p.plan_name || 'ë¯¸ì…ë ¥') + '</td>' +
                    '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ì‹œë¦¬ì–¼ë²ˆí˜¸</td>' +
                    '<td style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + (d.serial || 'ë¯¸ì…ë ¥') + '</td>' +
                '</tr>' +
                '<tr style="background:#f8f8f8;">' +
                    '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ëŒ€ì¸ë°°ìƒ</td>' +
                    '<td style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + cov.personal + '</td>' +
                    '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ëŒ€ë¬¼ë°°ìƒ</td>' +
                    '<td style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + cov.property + '</td>' +
                '</tr>' +
                '<tr style="background:#fff;">' +
                    '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ê¸°ë³¸ë³´ì¥</td>' +
                    '<td style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + cov.additional + '</td>' +
                    '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ë³´í—˜ë£Œ</td>' +
                    '<td style="padding:4px 10px;font-size:9px;font-weight:700;color:#cc8800;border-bottom:1px solid #eee;">' + parseInt(p.price || 0).toLocaleString() + 'ì›/ë…„</td>' +
                '</tr>';
        });
    } else {
        var cov = getCoverageInfo(insuranceData.plan);
        droneRows +=
            '<tr style="background:#f8f8f8;">' +
                '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ë“œë¡  ì¢…ë¥˜</td>' +
                '<td colspan="3" style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + (droneTypes[insuranceData.drone_type] || 'ë¯¸ì…ë ¥') + '</td>' +
            '</tr>' +
            '<tr style="background:#fff;">' +
                '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ì„ íƒ í”Œëœ</td>' +
                '<td colspan="3" style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + (insuranceData.plan_name || 'ë¯¸ì…ë ¥') + '</td>' +
            '</tr>' +
            '<tr style="background:#f8f8f8;">' +
                '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ëŒ€ì¸ë°°ìƒ</td>' +
                '<td style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + cov.personal + '</td>' +
                '<td style="padding:4px 10px;font-size:9px;color:#555;border-bottom:1px solid #eee;">ëŒ€ë¬¼ë°°ìƒ</td>' +
                '<td style="padding:4px 10px;font-size:9px;border-bottom:1px solid #eee;">' + cov.property + '</td>' +
            '</tr>';
    }

    // â”€â”€ PDF ì „ì²´ HTML â”€â”€
    // í•µì‹¬: display:grid ê¸ˆì§€, CSS gradient ê¸ˆì§€, ëª¨ë‘ <table> + bgcolor ë‹¨ìƒ‰
    var pdfHTML =
        '<div style="width:190mm;font-family:Arial,Helvetica,sans-serif;font-size:10px;color:#1a1a1a;background:#ffffff;">' +

        // í—¤ë” (ë‹¨ìƒ‰ ë°°ê²½)
        '<table width="100%" style="background:#FFB800;margin-bottom:12px;" cellpadding="0" cellspacing="0"><tr>' +
        '<td style="padding:14px 20px;text-align:center;">' +
        '<div style="font-size:16px;font-weight:900;color:#1a1a1a;">ë°°ìƒì˜¨ ê°œì¸ìš©ë“œë¡ ë³´í—˜ ê²¬ì ì„œ</div>' +
        '</td></tr></table>' +

        // ê²¬ì ì •ë³´ + ê³ ê°ì •ë³´ (2ì»¬ëŸ¼ table)
        '<table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:10px;border-collapse:collapse;">' +
        '<tr>' +
        '<td width="50%" valign="top" style="padding-right:5px;">' +
        '<table width="100%" cellpadding="0" cellspacing="0" style="background:#f8f8f8;border-radius:4px;">' +
        '<tr><td colspan="2" style="background:#cc8800;padding:6px 10px;font-weight:700;font-size:10px;color:#fff;">ê²¬ì  ì •ë³´</td></tr>' +
        '<tr><td style="padding:4px 10px;font-size:9px;color:#555;width:40%;">ê²¬ì ì¼ì</td><td style="padding:4px 10px;font-size:9px;">' + dateStr + '</td></tr>' +
        '<tr style="background:#fff;"><td style="padding:4px 10px;font-size:9px;color:#555;">ë³´í—˜ ì‹œì‘</td><td style="padding:4px 10px;font-size:9px;">' + fmtDT(insuranceData.insurance_start) + '</td></tr>' +
        '<tr><td style="padding:4px 10px;font-size:9px;color:#555;">ë³´í—˜ ì¢…ë£Œ</td><td style="padding:4px 10px;font-size:9px;">' + fmtDT(insuranceData.insurance_end) + '</td></tr>' +
        '<tr style="background:#fff;"><td style="padding:4px 10px;font-size:9px;color:#555;">ìƒí’ˆëª…</td><td style="padding:4px 10px;font-size:9px;">KBì†í•´ë³´í—˜ ê°œì¸ìš© ë“œë¡ ë³´í—˜</td></tr>' +
        '</table>' +
        '</td>' +
        '<td width="50%" valign="top" style="padding-left:5px;">' +
        '<table width="100%" cellpadding="0" cellspacing="0" style="background:#f8f8f8;border-radius:4px;">' +
        '<tr><td colspan="2" style="background:#cc8800;padding:6px 10px;font-weight:700;font-size:10px;color:#fff;">ê³ ê° ì •ë³´</td></tr>' +
        '<tr><td style="padding:4px 10px;font-size:9px;color:#555;width:35%;">ì´ë¦„</td><td style="padding:4px 10px;font-size:9px;">' + (insuranceData.name || '') + '</td></tr>' +
        '<tr style="background:#fff;"><td style="padding:4px 10px;font-size:9px;color:#555;">ì—°ë½ì²˜</td><td style="padding:4px 10px;font-size:9px;">' + (insuranceData.phone || '') + '</td></tr>' +
        '<tr><td style="padding:4px 10px;font-size:9px;color:#555;">ì´ë©”ì¼</td><td style="padding:4px 10px;font-size:9px;">' + (insuranceData.email || '') + '</td></tr>' +
        '<tr style="background:#fff;"><td style="padding:4px 10px;font-size:9px;color:#555;">ë“œë¡  ëŒ€ìˆ˜</td><td style="padding:4px 10px;font-size:9px;">' + (insuranceData.drone_count || 1) + 'ëŒ€</td></tr>' +
        '</table>' +
        '</td>' +
        '</tr>' +
        '</table>' +

        // ë“œë¡  ì •ë³´
        '<table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:10px;border-collapse:collapse;">' +
        '<tr><td colspan="4" style="background:#1a1a1a;padding:6px 10px;font-weight:700;font-size:10px;color:#FFB800;">ë“œë¡  ì •ë³´ (' + (insuranceData.drone_count || 1) + 'ëŒ€)</td></tr>' +
        droneRows +
        '</table>' +

        // ì´ ë³´í—˜ë£Œ (ë‹¨ìƒ‰ ë°°ê²½)
        '<table width="100%" cellpadding="0" cellspacing="0" style="background:#FFB800;margin-bottom:10px;"><tr>' +
        '<td style="padding:14px;text-align:center;">' +
        '<div style="font-size:10px;color:#1a1a1a;margin-bottom:4px;">ì—°ê°„ ì´ ë³´í—˜ë£Œ</div>' +
        '<div style="font-size:22px;font-weight:900;color:#1a1a1a;">' + total.toLocaleString() + 'ì›</div>' +
        '</td></tr></table>' +

        // ìœ ì˜ì‚¬í•­
        '<table width="100%" cellpadding="0" cellspacing="0" style="background:#fffbea;margin-bottom:10px;"><tr>' +
        '<td style="padding:10px 12px;font-size:8px;color:#666;line-height:1.8;">' +
        '<strong style="color:#1a1a1a;display:block;margin-bottom:3px;">ìœ ì˜ì‚¬í•­</strong>' +
        'â€» êµ¬ì²´ì ì¸ ë³´ì¥/ë©´ì±… ë° ë³´í—˜ê¸ˆ ì§€ê¸‰ì€ ì•½ê´€ì— ë”°ë¦…ë‹ˆë‹¤.<br>' +
        'â€» ë³¸ ê²¬ì ì„œëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ë³´í—˜ë£ŒëŠ” ì‹¬ì‚¬ í›„ í™•ì •ë©ë‹ˆë‹¤.' +
        '</td></tr></table>' +

        // í‘¸í„°
        '<table width="100%" cellpadding="0" cellspacing="0" style="background:#1a1a1a;"><tr>' +
        '<td style="padding:12px;text-align:center;">' +
        '<div style="font-size:11px;font-weight:700;color:#ffffff;margin-bottom:3px;">ë°°ìƒì˜¨ ëŒ€ë¦¬ì </div>' +
        '<div style="font-size:8px;color:#aaaaaa;">liab.on.ins@gmail.com | www.liab.co.kr | KBì†í•´ë³´í—˜ ê³µì‹ ëŒ€ë¦¬ì </div>' +
        '</td></tr></table>' +

        '</div>';

    var el = document.createElement('div');
    el.innerHTML = pdfHTML;
    document.body.appendChild(el);
    el.style.position = 'absolute';
    el.style.left = '-9999px';
    el.style.top = '0';

    var filename = 'KB_ë“œë¡ ë³´í—˜_ê²¬ì ì„œ_' +
        (insuranceData.name || '') + '_' +
        today.getFullYear() +
        String(today.getMonth() + 1).padStart(2, '0') +
        String(today.getDate()).padStart(2, '0') + '.pdf';

    try {
        await html2pdf().set({
            margin: [5, 5, 5, 5],
            filename: filename,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: {
                scale: 2,
                useCORS: true,
                letterRendering: true,
                logging: false,
                allowTaint: false
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(el).save();
    } catch (err) {
        console.error('PDF ì˜¤ë¥˜:', err);
        alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        document.body.removeChild(el);
        pdfBtn.disabled = false;
        pdfBtn.textContent = 'ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ';
    }
}

/* ===========================================
   ì´ë©”ì¼ ì „ì†¡ (ê³ ê°ì—ê²Œë§Œ)
=========================================== */
async function sendEmail() {
    if (!insuranceData) {
        alert('ë³´í—˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    var emailBtn = document.querySelector('.btn-email');
    emailBtn.disabled    = true;
    emailBtn.textContent = 'ì „ì†¡ ì¤‘...';

    try {
        var res = await fetch('/api/contact', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(Object.assign({}, insuranceData, {
                insurance_type: 'ê°œì¸ìš© ë“œë¡ ë³´í—˜',
                request_type:   'quote_email'
            }))
        });

        if (res.ok) {
            alert('ê²¬ì ì„œê°€ ' + (insuranceData.email || '') + ' ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert('ì´ë©”ì¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    } catch (e) {
        console.error('ì´ë©”ì¼ ì˜¤ë¥˜:', e);
        alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
        emailBtn.disabled    = false;
        emailBtn.textContent = 'ğŸ“§ ì´ë©”ì¼ ì „ì†¡';
    }
}
</script>

</body>
</html>
