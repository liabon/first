<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê²¬ì ì„œ í™•ì¸ - KBì†í•´ë³´í—˜ ê°œì¸ìš© ë“œë¡ ë³´í—˜</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --kb-yellow: #FFCD00;
      --kb-gold: #FFB800;
      --kb-dark: #1a1a1a;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      color: var(--kb-dark);
      line-height: 1.6;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .kb-logo { height: 50px; }
    .divider { height: 40px; width: 1px; background: #ddd; }

    .agency-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--kb-dark);
    }

    .main-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem 2rem;
    }

    .complete-card {
      background: #fff;
      border-radius: 30px;
      padding: 4rem 3rem;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .title-section {
      text-align: center;
      margin-bottom: 3rem;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: var(--kb-gold);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      font-size: 2.5rem;
    }

    .complete-title {
      font-size: 2rem;
      font-weight: 900;
      margin-bottom: 0.5rem;
      color: var(--kb-dark);
    }

    .complete-subtitle { font-size: 1rem; color: #666; }

    .quote-box {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .quote-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--kb-gold);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.8rem 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .info-row:last-child { border-bottom: none; }

    .info-label { font-weight: 600; color: #666; }
    .info-value { font-weight: 700; color: var(--kb-dark); }

    .total-price {
      background: var(--kb-gold);
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      margin: 2rem 0;
    }

    .total-price-label { font-size: 1rem; margin-bottom: 0.5rem; }
    .total-price-value { font-size: 2.5rem; font-weight: 900; color: var(--kb-dark); }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .btn {
      padding: 1.2rem;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-pdf { background: #e74c3c; color: #fff; }
    .btn-pdf:hover { background: #c0392b; transform: translateY(-2px); }

    .btn-email { background: var(--kb-gold); color: var(--kb-dark); }
    .btn-email:hover { background: var(--kb-yellow); transform: translateY(-2px); }

    .navigation-buttons {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1rem;
    }

    .btn-back { background: #e0e0e0; color: var(--kb-dark); }
    .btn-back:hover { background: #d0d0d0; }

    .btn-payment { background: var(--kb-dark); color: #fff; }
    .btn-payment:hover { background: #000; transform: translateY(-2px); }

    .notice {
      background: #fff9e6;
      padding: 1.5rem;
      border-radius: 12px;
      margin-top: 2rem;
      font-size: 0.95rem;
      color: #666;
    }

    .notice strong {
      color: var(--kb-dark);
      display: block;
      margin-bottom: 0.5rem;
    }

    footer {
      background: var(--kb-dark);
      color: #fff;
      padding: 2rem;
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.8;
    }

    @media (max-width: 768px) {
      .complete-card { padding: 3rem 2rem; }
      .action-buttons, .navigation-buttons { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo-section">
        <img src="kb-logo.png" alt="KBì†í•´ë³´í—˜" class="kb-logo" />
        <div class="divider"></div>
        <div class="agency-name">ë°°ìƒì˜¨ ëŒ€ë¦¬ì </div>
      </div>
    </div>
  </header>

  <div class="main-content">
    <div class="complete-card">
      <div class="title-section">
        <div class="success-icon">ğŸ“‹</div>
        <h1 class="complete-title">ê²¬ì ì„œ í™•ì¸</h1>
        <p class="complete-subtitle">ì…ë ¥í•˜ì‹  ì •ë³´ë¥¼ í™•ì¸í•˜ì‹œê³  ê²¬ì ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ì´ë©”ì¼ë¡œ ë°›ì•„ë³´ì„¸ìš”</p>
      </div>

      <div class="quote-box">
        <h2 class="quote-title">ë³´í—˜ ì •ë³´</h2>
        <div id="insuranceInfo"></div>
      </div>

      <div class="total-price">
        <div class="total-price-label">ì´ ë³´í—˜ë£Œ</div>
        <div class="total-price-value" id="totalPrice">0ì›</div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-pdf" onclick="downloadPDF()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-email" onclick="sendEmail()">ğŸ“§ ì´ë©”ì¼ ì „ì†¡</button>
      </div>

      <div class="navigation-buttons">
        <button class="btn btn-back" onclick="history.back()">ì´ì „</button>
        <button class="btn btn-payment" onclick="alert('ê²°ì œ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')">ê²°ì œí•˜ê¸°</button>
      </div>

      <div class="notice">
        <strong>ì•ˆë‚´ì‚¬í•­</strong>
        â€¢ ê²¬ì ì„œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ì´ë©”ì¼ë¡œ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br />
        â€¢ ê°€ì…ì„ ì›í•˜ì‹œë©´ ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br />
        â€¢ ê²¬ì ì„œëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ë³´í—˜ë£ŒëŠ” ì‹¬ì‚¬ í›„ í™•ì •ë©ë‹ˆë‹¤.<br />
        â€¢ ë¬¸ì˜ì‚¬í•­: liab.on.ins@gmail.com
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p>Â© 2026 ë°°ìƒì˜¨ ëŒ€ë¦¬ì . All rights reserved. | KBì†í•´ë³´í—˜ ê³µì‹ ëŒ€ë¦¬ì </p>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    let insuranceData = null;

    window.addEventListener('DOMContentLoaded', function () {
      const savedData = sessionStorage.getItem('droneInsuranceData');
      if (!savedData) {
        alert('ì €ì¥ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        window.location.href = '/personal-drone-insurance';
        return;
      }
      insuranceData = JSON.parse(savedData);
      displayInfo();
    });

    function displayInfo() {
      const container = document.getElementById('insuranceInfo');

      const droneTypes = {
        camera: 'ì´¬ì˜ìš© ì„¼ì„œë“œë¡ ',
        fpv: 'FPV/ë ˆì´ì‹± ë“œë¡ ',
        toy: 'ì™„êµ¬í˜• ë“œë¡ ',
        other: 'ê¸°íƒ€ ë“œë¡ '
      };

      const html = `
        <div class="info-row">
          <span class="info-label">ê°€ì…ìëª…</span>
          <span class="info-value">${insuranceData.name || ''}</span>
        </div>
        <div class="info-row">
          <span class="info-label">ì—°ë½ì²˜</span>
          <span class="info-value">${insuranceData.phone || ''}</span>
        </div>
        <div class="info-row">
          <span class="info-label">ì´ë©”ì¼</span>
          <span class="info-value">${insuranceData.email || ''}</span>
        </div>
        <div class="info-row">
          <span class="info-label">ë³´í—˜ê¸°ê°„</span>
          <span class="info-value">${insuranceData.insurance_start || ''} ~ ${insuranceData.insurance_end || ''}</span>
        </div>
        <div class="info-row">
          <span class="info-label">ë“œë¡  ì¢…ë¥˜</span>
          <span class="info-value">${droneTypes[insuranceData.drone_type] || 'ë¯¸ì…ë ¥'}</span>
        </div>
        <div class="info-row">
          <span class="info-label">ë“œë¡  ëŒ€ìˆ˜</span>
          <span class="info-value">${insuranceData.drone_count || 1}ëŒ€</span>
        </div>
        <div class="info-row">
          <span class="info-label">ì„ íƒ í”Œëœ</span>
          <span class="info-value">${insuranceData.plan_name || ''}</span>
        </div>
        <div class="info-row">
          <span class="info-label">ë³´í—˜ë£Œ(1ëŒ€ë‹¹)</span>
          <span class="info-value">${insuranceData.plan_price_per_drone ? parseInt(insuranceData.plan_price_per_drone).toLocaleString() : '0'}ì›/ë…„</span>
        </div>
      `;

      container.innerHTML = html;
      document.getElementById('totalPrice').textContent =
        `${insuranceData.plan_total_price ? parseInt(insuranceData.plan_total_price).toLocaleString() : '0'}ì›`;
    }

    function getCoverageHTML(plan) {
      if (!plan) return '<p style="margin: 6px 0; font-size: 13px;">í”Œëœ ì •ë³´ ì—†ìŒ</p>';

      let coverage = { personal: '', property: '', additional: '' };

      if (plan.includes('slim')) {
        coverage.personal = '50,000,000ì›';
        coverage.property = '50,000,000ì›';
      } else if (plan.includes('standard')) {
        coverage.personal = '100,000,000ì›';
        coverage.property = '100,000,000ì›';
      } else if (plan.includes('premium')) {
        coverage.personal = '500,000,000ì›';
        coverage.property = '500,000,000ì›';
      }

      if (plan.includes('camera')) {
        if (plan.includes('slim')) coverage.additional = 'ê¸°ë³¸ì¶©ì‹¤';
        else if (plan.includes('standard')) coverage.additional = 'ëˆ„êµ¬ë‚˜ìš´ì „ í¬í•¨';
        else if (plan.includes('premium')) coverage.additional = 'ëˆ„êµ¬ë‚˜ìš´ì „ + êµ¬ì¡°ë¹„ìš©';
      } else if (plan.includes('fpv')) {
        if (plan.includes('slim')) coverage.additional = 'ë“œë¡ ê²½ê¸°ì¤‘ ë³´ì¥';
        else if (plan.includes('standard')) coverage.additional = 'ë“œë¡ ê²½ê¸°ì¤‘ + ëˆ„êµ¬ë‚˜ìš´ì „';
        else if (plan.includes('premium')) coverage.additional = 'ë“œë¡ ê²½ê¸°ì¤‘ + ëˆ„êµ¬ë‚˜ìš´ì „ + êµ¬ì¡°ë¹„ìš©';
      } else {
        if (plan.includes('slim')) coverage.additional = 'ê¸°ë³¸ ë³´ì¥';
        else if (plan.includes('standard')) coverage.additional = 'ëˆ„êµ¬ë‚˜ìš´ì „ í¬í•¨';
        else if (plan.includes('premium')) coverage.additional = 'ëˆ„êµ¬ë‚˜ìš´ì „ + êµ¬ì¡°ë¹„ìš©';
      }

      return `
        <div style="border-left: 3px solid #FFB800; padding-left: 12px; margin: 10px 0 0 8px; page-break-inside: avoid;">
          <p style="margin: 6px 0; font-size: 13px; line-height: 1.45;"><strong>ëŒ€ì¸ë°°ìƒ:</strong> ${coverage.personal}</p>
          <p style="margin: 6px 0; font-size: 13px; line-height: 1.45;"><strong>ëŒ€ë¬¼ë°°ìƒ:</strong> ${coverage.property}</p>
          <p style="margin: 6px 0; font-size: 13px; line-height: 1.45;"><strong>ê¸°ë³¸ë³´ì¥:</strong> ${coverage.additional}</p>
        </div>
      `;
    }

    async function downloadPDF() {
      const droneTypes = {
        camera: 'ì´¬ì˜ìš© ì„¼ì„œë“œë¡ ',
        fpv: 'FPV/ë ˆì´ì‹± ë“œë¡ ',
        toy: 'ì™„êµ¬í˜• ë“œë¡ ',
        other: 'ê¸°íƒ€ ë“œë¡ '
      };

      const today = new Date();
      const dateStr = `${today.getFullYear()}. ${String(today.getMonth() + 1)}. ${String(today.getDate())}.`;

      // âœ… A4 ê³ ì • + ìƒë‹¨ ì˜ë¦¼/ê³µë°± ë°©ì§€ PDF HTML
      const pdfContent = `
        <style>
          @page { margin: 0; }
          html, body { margin: 0 !important; padding: 0 !important; background: #fff; }
          * { box-sizing: border-box; }
          .a4 { width: 210mm; min-height: 297mm; background: #fff; }
          .pad { padding: 14mm 14mm 12mm 14mm; }
          .card { background:#f8f9fa; border-radius:8px; padding:12px 14px; }
          .h3 { color:#FFB800; margin:0 0 10px 0; font-size:15px; font-weight:800; }
          .p { margin:4px 0; font-size:12.5px; line-height:1.45; }
        </style>

        <div class="a4">
          <div style="background:linear-gradient(135deg,#FFB800 0%,#FFCD00 100%); padding:22mm 14mm 16mm 14mm; text-align:center;">
            <h1 style="color:#1a1a1a; margin:0; font-size:26px; font-weight:900; line-height:1.2;">KBì†í•´ë³´í—˜ ê°œì¸ìš© ë“œë¡ ë³´í—˜</h1>
            <h2 style="color:#1a1a1a; margin:10px 0 0 0; font-size:18px; font-weight:800;">ê²¬ì ì„œ</h2>
          </div>

          <div class="pad">
            <div class="card" style="margin-bottom:12px; page-break-inside:avoid;">
              <div class="h3">ğŸ“‹ ê²¬ì  ì •ë³´</div>
              <div class="p"><strong>ê²¬ì ì¼ì:</strong> ${dateStr}</div>
              <div class="p"><strong>ë³´í—˜ê¸°ê°„:</strong> ${insuranceData.insurance_start || 'ë¯¸ì…ë ¥'} ~ ${insuranceData.insurance_end || 'ë¯¸ì…ë ¥'}</div>
              <div class="p"><strong>ìƒí’ˆëª…:</strong> KBì†í•´ë³´í—˜ ê°œì¸ìš© ë“œë¡ ë³´í—˜</div>
            </div>

            <div class="card" style="margin-bottom:12px; page-break-inside:avoid;">
              <div class="h3">ğŸ‘¤ ê³ ê° ì •ë³´</div>
              <div class="p"><strong>ì´ë¦„:</strong> ${insuranceData.name || 'ë¯¸ì…ë ¥'}</div>
              <div class="p"><strong>ì—°ë½ì²˜:</strong> ${insuranceData.phone || 'ë¯¸ì…ë ¥'}</div>
              <div class="p"><strong>ì´ë©”ì¼:</strong> ${insuranceData.email || 'ë¯¸ì…ë ¥'}</div>
            </div>

            <div class="card" style="margin-bottom:12px; page-break-inside:avoid;">
              <div class="h3">ğŸš ë“œë¡  ì •ë³´</div>
              <div class="p"><strong>ë“œë¡  ì¢…ë¥˜:</strong> ${droneTypes[insuranceData.drone_type] || 'ë¯¸ì…ë ¥'}</div>
              <div class="p"><strong>ë“œë¡  ëŒ€ìˆ˜:</strong> ${insuranceData.drone_count || 1}ëŒ€</div>

              ${
                insuranceData.drones && insuranceData.drones.length > 0
                  ? insuranceData.drones.map((drone, i) => `
                    <div style="border-left:3px solid #FFB800; padding-left:10px; margin:10px 0 0 8px; page-break-inside:avoid;">
                      <div class="p" style="font-weight:800;">ë“œë¡  ${i + 1}</div>
                      <div class="p">ëª¨ë¸ëª…: ${drone.model || 'ë¯¸ì…ë ¥'}</div>
                      <div class="p">ì‹œë¦¬ì–¼ë²ˆí˜¸: ${drone.serial || 'ë¯¸ì…ë ¥'}</div>
                      <div class="p">ìì²´ì¤‘ëŸ‰: ${drone.weight || 'ë¯¸ì…ë ¥'}kg</div>
                      <div class="p">ìµœëŒ€ì´ë¥™ì¤‘ëŸ‰: ${drone.max_weight || 'ë¯¸ì…ë ¥'}kg</div>
                    </div>
                  `).join('')
                  : ''
              }
            </div>

            <div class="card" style="margin-bottom:12px; page-break-inside:avoid;">
              <div class="h3">ğŸ’° ë³´ì¥ ë‚´ìš©</div>
              <div class="p"><strong>ì„ íƒ í”Œëœ:</strong> ${insuranceData.plan_name || 'ë¯¸ì…ë ¥'}</div>
              ${getCoverageHTML(insuranceData.plan)}
              <div class="p" style="margin-top:10px;"><strong>ìê¸°ë¶€ë‹´ê¸ˆ:</strong> 100,000ì›</div>
            </div>

            <div style="background:#FFB800; padding:16px 12px; border-radius:8px; text-align:center; margin-bottom:12px; page-break-inside:avoid;">
              <div style="margin:0 0 6px 0; color:#1a1a1a; font-size:13px; font-weight:700;">ì—°ê°„ ë³´í—˜ë£Œ</div>
              <div style="margin:0; color:#1a1a1a; font-size:30px; font-weight:900; line-height:1.1;">
                ${insuranceData.plan_total_price ? parseInt(insuranceData.plan_total_price).toLocaleString() : '0'}ì›
              </div>
              <div style="margin:8px 0 0 0; color:#1a1a1a; font-size:13px;">
                1ëŒ€ë‹¹ ${insuranceData.plan_price_per_drone ? parseInt(insuranceData.plan_price_per_drone).toLocaleString() : '0'}ì›
              </div>
            </div>

            <div style="background:#fff9e6; padding:12px; border-radius:8px; font-size:11.5px; color:#666; line-height:1.55; page-break-inside:avoid;">
              <div style="margin:0 0 6px 0; font-weight:900; color:#1a1a1a;">ìœ ì˜ì‚¬í•­</div>
              <div style="margin:4px 0;">â€» êµ¬ì²´ì ì¸ ë³´ì¥/ë©´ì±… ë° ë³´í—˜ê¸ˆ ì§€ê¸‰ì€ ì•½ê´€ì— ë”°ë¦…ë‹ˆë‹¤.</div>
              <div style="margin:4px 0 0 0;">â€» ë³¸ ê²¬ì ì„œëŠ” ì°¸ê³ ìš©ì´ë©°, ìµœì¢… ë³´í—˜ë£ŒëŠ” ì‹¬ì‚¬ í›„ í™•ì •ë©ë‹ˆë‹¤.</div>
            </div>
          </div>

          <div style="background:#1a1a1a; padding:10mm 14mm; text-align:center; color:#fff;">
            <div style="font-size:15px; font-weight:900;">ë°°ìƒì˜¨ ëŒ€ë¦¬ì </div>
            <div style="margin:6px 0; font-size:12.5px;">ğŸ“§ liab.on.ins@gmail.com | ğŸŒ www.liab.co.kr</div>
            <div style="margin-top:6px; font-size:11px; opacity:0.75;">KBì†í•´ë³´í—˜ ê³µì‹ ëŒ€ë¦¬ì </div>
          </div>
        </div>
      `;

      const filename = `KB_ë“œë¡ ë³´í—˜_ê²¬ì ì„œ_${insuranceData.name || 'ê³ ê°'}_${today.getFullYear()}${String(today.getMonth()+1).padStart(2,'0')}${String(today.getDate()).padStart(2,'0')}.pdf`;

      // âœ… í•µì‹¬: ìˆ¨ê¸°ì§€ ë§ê³  "í™”ë©´ ë°–"ìœ¼ë¡œ ë³´ë‚´ê¸° (opacity 0 / z-index -1 ê¸ˆì§€)
      const wrapper = document.createElement('div');
      wrapper.innerHTML = pdfContent;
      wrapper.id = 'pdf-temp-wrapper';
      wrapper.style.position = 'fixed';
      wrapper.style.left = '-10000px';
      wrapper.style.top = '0';
      wrapper.style.width = '210mm';
      wrapper.style.background = '#fff';
      wrapper.style.opacity = '1';
      wrapper.style.zIndex = '2147483647';

      document.body.appendChild(wrapper);

      // í°íŠ¸/ë ˆì´ì•„ì›ƒ ë°˜ì˜ ì•ˆì •í™”
      await new Promise(r => setTimeout(r, 150));

      const opt = {
        margin: 0,
        filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          backgroundColor: '#ffffff',
          scrollX: 0,
          scrollY: 0,
          // ë¸Œë¼ìš°ì €ë³„ ìƒë‹¨ ì˜ë¦¼ ë°©ì§€ì— ë„ì›€
          // scrollY: -window.scrollY,
          windowWidth: 794,
          letterRendering: true
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };

      try {
        await html2pdf().set(opt).from(wrapper).save();
      } finally {
        document.body.removeChild(wrapper);
      }
    }

    async function sendEmail() {
      try {
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...insuranceData,
            insurance_type: 'ê°œì¸ìš© ë“œë¡ ë³´í—˜',
            request_type: 'quote_email',
            send_to_customer: true
          })
        });

        if (response.ok) {
          alert(`ê²¬ì ì„œê°€ ${insuranceData.email}ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
          alert('ì´ë©”ì¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('ì´ë©”ì¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>
</body>
</html>
